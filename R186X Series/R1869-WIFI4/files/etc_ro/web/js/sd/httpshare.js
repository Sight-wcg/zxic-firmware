define(["jquery","underscore","lib/jquery/jQuery.fileinput","config/config","service","knockout"],function(y,M,i,C,g,K){var j=10;var E=1;var L="";var p=C.SD_BASE_PATH;var h="";var w=true;var v=null,A=null,b=null;var H=new Date().getTimezoneOffset()*60;var n="";var l=false;function c(O,T,R){if(O==0){return[]}var U=[];var S=J(O,T);U.push({pageNum:R-1,isActive:false,isPrev:true,isNext:false,isDot:false});if(R==6){U.push({pageNum:1,isActive:false,isPrev:false,isNext:false,isDot:false})}else{if(R>5){U.push({pageNum:1,isActive:false,isPrev:false,isNext:false,isDot:false});U.push({pageNum:0,isPrev:false,isNext:false,isActive:false,isDot:true})}}var Q;var P=R-4>0?R-4:1;var N=R+4;for(Q=P;Q<=N&&Q<=S;Q++){U.push({pageNum:Q,isActive:Q==R,isPrev:false,isNext:false,isDot:false})}if(R+5==S){U.push({pageNum:S,isPrev:false,isNext:false,isActive:false,isDot:false})}else{if(R+3<=S&&Q-1!=S){U.push({pageNum:0,isPrev:false,isNext:false,isActive:false,isDot:true});U.push({pageNum:S,isPrev:false,isNext:false,isActive:false,isDot:false})}}U.push({pageNum:parseInt(R,10)+1,isPrev:false,isNext:true,isActive:false,isDot:false});return U}function J(P,N){var O=Math.floor(P/N);if(P%N!=0){O++}return O}function I(P){var O=0;var N=y.map(P,function(R){var Q={fileName:HTMLEncode(R.fileName),fileType:R.attribute=="document"?"folder":getFileType(R.fileName),fileSize:getDisplayVolume(R.size,false),filePath:p+s()+"/"+R.fileName,lastUpdateTime:transUnixTime((parseInt(R.lastUpdateTime,10)+H)*1000),trClass:O%2==0?"even":"",readwrite:w};O++;return Q});if(v==null){v=y.template("sdFileItemTmpl",y("#sdFileItemTmpl"))}y("#fileList_container").html(y.tmpl("sdFileItemTmpl",{data:N}))}function D(){var N=false;if(window.location.hash=="#httpshare_guest"){N=true}w=true;E=1;m("");p=C.SD_BASE_PATH;showLoading("waiting");g.getSDConfiguration({},function(O){b=O;n=O.share_file;if(n.charAt(n.length-1)=="/"){n=n.substring(0,n.length-1)}if(O.sd_status=="1"&&O.sd_mode=="0"){if(N&&O.share_status=="1"){p=n;if(O.share_auth=="0"){w=false;y("#uploadSection, #delete_file_button, .sd_guest_hide_th","#httpshare_form").hide()}else{y("#uploadSection, #delete_file_button, .sd_guest_hide_th","#httpshare_form").show()}y("#go_to_login_button").removeClass("hide");y("#sd_menu").hide();y(".form-note").hide();if(y(".customfile").length==0){y("#fileField").customFileInput()}pagerItemClickHandler(1)}else{if(N&&O.share_status=="0"){y(".form-body .content","#httpshare_form").hide().remove();y(".form-title","#httpshare_form").attr("data-trans","httpshare").html(y.i18n.prop("httpshare"));y(".form-note","#httpshare_form").attr("data-trans","note_http_share_cannot_access").html(y.i18n.prop("note_http_share_cannot_access"));hideLoading()}else{if(y(".customfile").length==0){y("#fileField").customFileInput()}pagerItemClickHandler(1)}}}else{y(".form-body .content","#httpshare_form").hide().remove();y(".form-title","#httpshare_form").attr("data-trans","httpshare").html(y.i18n.prop("httpshare"));y(".form-note","#httpshare_form").attr("data-trans","note_http_share_usb_access").html(y.i18n.prop("note_http_share_usb_access"));y(".form-note","#httpshare_form").addClass("margintop10");hideLoading()}},function(){errorOverlay();y(".form-body .content","#httpshare_form").hide().remove();y(".form-title","#httpshare_form").attr("data-trans","httpshare").html(y.i18n.prop("httpshare"));y(".form-note","#httpshare_form").attr("data-trans","note_http_share_cannot_access").html(y.i18n.prop("note_http_share_cannot_access"))});addInterval(function(){!l&&self.checkSdStatus()},3000);self.checkSdStatus=function(){var O=g.getSDConfiguration();if(O.sd_status&&(O.sd_status!=b.sd_status)){if(O.sd_status=="1"){window.location.reload()}else{clearTimer();clearValidateMsg();G()}}}}pagerItemClickHandler=function(N){E=N;refreshFileList(s(),E)};function u(){var N=g.getSDConfiguration();if(!M.isEqual(b,N)){showAlert("sd_config_changed_reload",function(){G()});return false}return true}function q(P,Q){var O=n+"/";var N=P+"/";if(b.share_status=="1"&&n!=""&&n!="/"&&O.indexOf(N)!=-1){showAlert(Q);return true}return false}enterFolder=function(N){if(!u()){return false}var O;if(N==""){O=""}else{O=s()+"/"+N}refreshFileList(O,1);return true};backFolder=function(){if(!u()){return false}var N=s().substring(0,s().lastIndexOf("/"));refreshFileList(N,1);return true};refreshFileList=function(P,O,N){if(!N){showLoading("waiting")}g.getFileList({path:h+p+P,index:O},function(Q){if(isErrorObject(Q)){showAlert(Q.errorType);return}m(P);y("#sd_path").val(P);E=O;totalSize=Q.totalRecord;I(Q.details);pagination(totalSize);refreshBtnsStatus();updateSdMemorySizes();if(!N){hideLoading()}})};refreshBtnsStatus=function(){if(s()==""){y("#rootBtnLi, #backBtnLi").hide()}else{y("#rootBtnLi, #backBtnLi").show()}if(w){y("#createNewFolderLi").hide();y("#createNewFolderLi").find(".error").hide();y("#newFolderBtnLi").show();y("#newFolderName").val("");y("#createNewFolderErrorLabel").removeAttr("data-trans").text("")}else{y("#newFolderBtnLi, #createNewFolderLi").hide().remove()}z()};openCreateNewFolderClickHandler=function(){y("#newFolderBtnLi").hide();y("#newFolderName").show();y("#createNewFolderLi").show()};cancelCreateNewFolderClickHandler=function(){y("#createNewFolderLi").hide();y("#newFolderName").val("");y("#newFolderBtnLi").show();y("#createNewFolderLi").find(".error").hide()};createNewFolderClickHandler=function(){if(!u()){return false}var O=y.trim(y("#newFolderName").val());var N=h+p+s()+"/"+O;showLoading("creating");g.checkFileExists({path:N},function(P){if(P.status=="noexist"||P.status=="processing"){g.createFolder({path:N},function(Q){if(isErrorObject(Q)){showAlert(Q.errorType);return false}else{successOverlay();refreshFileList(s(),1)}})}else{if(P.status=="no_sdcard"){showAlert("no_sdcard",function(){window.location.reload()})}else{if(P.status=="exist"){y("#createNewFolderErrorLabel").attr("data-trans","sd_card_share_setting_exist").text(y.i18n.prop("sd_card_share_setting_exist"));hideLoading()}}}},function(){errorOverlay()});return true};renameBtnClickHandler=function(N){var O=h+p+s()+"/"+N;if(q(O,"sd_share_path_cant_rename")){return false}showPrompt("sd_card_folder_name_is_null",function(){r(N)},160,N,F)};function r(N){if(!u()){return false}var Q=y("div#confirm div.promptDiv input#promptInput");var P=y.trim(Q.val());var O=h+p+s()+"/"+P;g.checkFileExists({path:O},function(R){if(R.status=="noexist"||R.status=="processing"){hideLoadingButtons();var S=h+p+s()+"/"+N;g.fileRename({oldPath:S,newPath:O,path:h+p+s()},function(U){if(isErrorObject(U)){showAlert(y.i18n.prop(U.errorType));if(U.errorType=="no_exist"){var T=true;refreshFileList(s(),1,T)}else{if(U.errorType=="processing"){}}}else{refreshFileList(s(),1);successOverlay()}showLoadingButtons();return true})}else{if(R.status=="no_sdcard"){showAlert("no_sdcard",function(){window.location.reload()});return false}else{if(R.status=="exist"){y(".promptErrorLabel").text(y.i18n.prop("sd_card_share_setting_exist"));return false}}}return true},function(){errorOverlay()});return false}function F(){var Q=y("div#confirm div.promptDiv input#promptInput");var O=y.trim(Q.val());var P=(h+p+s()+"/"+O).replace("//","/");var N=t(O,P);if(1==N){y(".promptErrorLabel").text(y.i18n.prop("sd_upload_rename_null"));return false}else{if(2==N){y(".promptErrorLabel").text(y.i18n.prop("sd_card_path_too_long"));return false}else{if(3==N){y(".promptErrorLabel").text(y.i18n.prop("check_file_path"));return false}else{y(".promptErrorLabel").text("");return true}}}return true}hideLoadingButtons=function(){y(".buttons","#confirm").hide()};showLoadingButtons=function(){y(".buttons","#confirm").show()};deleteBtnClickHandler=function(){if(!u()){return false}var P=y("input:checkbox:checked","#fileList_container");var N="";if(!P||P.length==0){return false}var O=false;y.each(P,function(Q,S){var R=y(S).val();if(q(h+p+s()+"/"+R,{msg:"sd_share_path_cant_delete",params:[R]})){O=true;return false}return true});if(O){return false}showConfirm("confirm_data_delete",function(){y.each(P,function(R,S){N+=y(S).val()+"*"});var Q=h+p+s();g.deleteFilesAndFolders({path:Q,names:N},function(R){if(R.status=="failure"){showAlert("delete_folder_failure")}else{if(R.status=="no_sdcard"){showAlert("no_sdcard")}else{if(R.status=="processing"){showAlert("sd_file_processing_cant_delete")}else{if(R.status=="success"){successOverlay()}}}}refreshFileList(s(),1)},function(){errorOverlay()})});return true};function o(R){var O=/msie/i.test(navigator.userAgent)&&!window.opera;if(O){var N=R.value;try{var P=new ActiveXObject("Scripting.FileSystemObject");fileLenth=parseInt(P.GetFile(N).size)}catch(Q){fileLenth=1}}else{try{fileLenth=parseInt(R.files[0].size)}catch(Q){fileLenth=1}}return fileLenth}fileUploadSubmitClickHandler=function(O){if(O){var Q=y.trim(y("div#confirm div.promptDiv input#promptInput").val())}else{var Q=y(".customfile").attr("title")}var P=(p+s()+"/"+Q).replace("//","/");var N=o(y("#fileField")[0]);if(!e(Q,P,N)){return false}k(Q,P,N)};function k(P,O,N){g.getSdMemorySizes({},function(Q){if(isErrorObject(Q)){showAlert(Q.errorType);return false}if(Q.availableMemorySize<N){showAlert("sd_upload_space_not_enough");return false}y.modal.close();showLoading("uploading",'<span data-trans="note_uploading_not_refresh">'+y.i18n.prop("note_uploading_not_refresh")+"</span>");g.checkFileExists({path:O},function(R){if(R.status=="noexist"){y("#fileUploadForm").attr("action","/cgi-bin/httpshare/"+URLEncodeComponent(P));var S=new Date().getTime();y("#path_SD_CARD_time").val(transUnixTime(S));y("#path_SD_CARD_time_unix").val(Math.round((S-H*1000)/1000));if(!f){d()}l=true;y("#fileUploadForm").submit()}else{if(R.status=="no_sdcard"){showAlert("no_sdcard",function(){window.location.reload()})}else{if(R.status=="processing"){showAlert("sd_upload_file_is_downloading")}else{if(R.status=="exist"){showPrompt("sd_upload_rename",function(){fileUploadSubmitClickHandler(true)},160,P,F,a)}}}}},function(){errorOverlay()});return true})}var f=false;function d(){f=true;y("#fileUploadIframe").load(function(){l=false;var O=y("#fileUploadIframe").contents().find("body").html().toLowerCase();var N=false;if(O.indexOf("success")!=-1){successOverlay()}else{if(O.indexOf("space_not_enough")!=-1){N=true;showAlert("sd_upload_space_not_enough")}else{if(O.indexOf("data_lost")!=-1){N=true;showAlert("sd_upload_data_lost")}else{errorOverlay()}}}a();refreshFileList(s(),1,N)})}function a(){y("#fileField").closest(".customfile").before('<input id="fileField" name="filename" maxlength="200" type="file" dir="ltr"/>').remove();addTimeout(function(){y("#fileField").customFileInput()},0);y("#uploadBtn","#uploadSection").attr("data-trans","browse_btn").html(y.i18n.prop("browse_btn"));y(".customfile","#uploadSection").removeAttr("title");y(".customfile span.customfile-feedback","#uploadSection").html('<span data-trans="no_file_selected">'+y.i18n.prop("no_file_selected")+"</span>").attr("class","customfile-feedback")}updateSdMemorySizes=function(){g.getSdMemorySizes({},function(P){if(isErrorObject(P)){showAlert(P.errorType);return false}var O=getDisplayVolume(P.totalMemorySize,false);var N=getDisplayVolume(P.totalMemorySize-P.availableMemorySize,false);y("#sd_volumn_used").text(N);y("#sd_volumn_total").text(O);return true})};pagination=function(N){var O=c(N,j,parseInt(E,10));if(A==null){A=y.template("pagerTmpl",y("#pagerTmpl"))}y(".pager","#fileListButtonSection").html(y.tmpl("pagerTmpl",{data:{pagers:O,total:J(N,j)}}));renderCheckbox();y(".content","#httpshare_form").translate()};function t(N,O){if(N==""||N.length>25){return 1}if(O.length>=200){return 2}if(!B(N,false)){return 3}}function e(P,O,N){if(!u()){return false}if(typeof P=="undefined"||P==""||P==y.i18n.prop("no_file_selected")){showAlert("sd_no_file_selected");return false}if(O.length>=200){showAlert("sd_card_path_too_long");return false}if(N/1024/1024/1024>2){showAlert("sd_file_size_too_big");return false}if(P.indexOf("*")>=0){showAlert("sd_file_name_invalid");return false}return true}function B(P,S){var R="+/:*?<>\"'\\|#&`~";if(S){R="+:*?<>\"'\\|#&`~"}var N=false;var U=false;var T=/^\.+$/;for(var O=0;O<P.length;O++){for(var Q=0;Q<R.length;Q++){if(P.charAt(O)==R.charAt(Q)){N=true;break}}if(T.test(P)){U=true}if(N||U){return false}}return true}checkFilePathForDownload=function(Q){if(!u()){return false}var N=Q.lastIndexOf("/");var O=Q.substring(0,N+1);var P=Q.substring(N+1,Q.length);if(B(O,true)&&B(P,false)){return true}showAlert("sd_card_invalid_chars_cant_download");return false};gotoLogin=function(){window.location.href="#login"};function x(){y("#createNewFolderForm").validate({submitHandler:function(){createNewFolderClickHandler()},rules:{newFolderName:{sd_card_path_too_long:true,check_filefold_name:true}}});y("p.checkbox","#httpshare_form").die().live("click",function(){addTimeout(function(){z()},100)});y(".icon-download","#httpshare_form").die().live("click",function(){return checkFilePathForDownload(y(this).attr("filelocal"))});y(".folderTd","#httpshare_form").die().live("click",function(){return enterFolder(y(this).attr("filename"))});y(".fileRename","#httpshare_form").die().live("click",function(){return renameBtnClickHandler(y(this).attr("filename"))});f=false}function z(){var N=y("p.checkbox.checkbox_selected","#fileListSection");if(N.length>0){enableBtn(y("#delete_file_button"))}else{disableBtn(y("#delete_file_button"))}}function s(){return L}function m(N){if(N.lastIndexOf("/")==N.length-1){L=N.substring(0,N.length-1)}else{L=N}}function G(){var N=y("#container")[0];K.cleanNode(N);var O=new D();K.applyBindings(O,N);x()}jQuery.validator.addMethod("check_filefold_name",function(P,O,Q){var N=B(P,false);return this.optional(O)||N});jQuery.validator.addMethod("sd_card_path_too_long",function(R,O,S){var Q=y.trim(y("#newFolderName").val());var P=h+p+s()+"/"+Q;var N=true;if(P.length>=200){N=false}return this.optional(O)||N});return{init:G}});