define(["knockout","service","jquery","config/config","home","opmode/opmode"],function(e,c,f,d,h,b){function a(){var j=this;var p=c.getStatusInfo();var m="PPPOE"==p.blc_wan_mode||"AUTO_PPPOE"==p.blc_wan_mode;j.hasRj45=d.RJ45_SUPPORT;j.hasSms=d.HAS_SMS;j.hasPhonebook=d.HAS_PHONEBOOK;j.isSupportSD=d.SD_CARD_SUPPORT;j.hasParentalControl=e.observable(d.HAS_PARENTAL_CONTROL&&m);j.pageState={NO_SIM:0,WAIT_PIN:1,WAIT_PUK:2,PUK_LOCKED:3,LOADING:4};if(d.WIFI_SUPPORT_QR_SWITCH){var l=c.getWifiBasic();j.showQRCode=d.WIFI_SUPPORT_QR_CODE&&l.show_qrcode_flag}else{j.showQRCode=d.WIFI_SUPPORT_QR_CODE}j.qrcodeSrc="./pic/qrcode_ssid_wifikey.png?_="+f.now();j.isHomePage=e.observable(false);if(window.location.hash=="#home"){j.isHomePage(true)}var o=c.getLoginData();j.PIN=e.observable();j.PUK=e.observable();j.newPIN=e.observable();j.confirmPIN=e.observable();j.pinNumber=e.observable(o.pinnumber);j.pukNumber=e.observable(o.puknumber);var n=i(o);j.page=e.observable(n);if(n==j.pageState.LOADING){addTimeout(k,500)}j.showOpModeWindow=function(){showSettingWindow("change_mode","opmode/opmode_popup","opmode/opmode_popup",400,300,function(){})};j.isLoggedIn=e.observable(false);j.enableFlag=e.observable(false);j.refreshOpmodeInfo=function(){var r=c.getStatusInfo();j.isLoggedIn(r.isLoggedIn);if(!m&&checkCableMode(r.blc_wan_mode)){if(j.page()==j.pageState.NO_SIM||j.page()==j.pageState.WAIT_PIN||j.page()==j.pageState.WAIT_PUK||j.page()==j.pageState.PUK_LOCKED){window.location.reload()}}m=checkCableMode(r.blc_wan_mode);j.hasParentalControl(d.HAS_PARENTAL_CONTROL&&m);if(m&&r.ethWanMode.toUpperCase()=="DHCP"){j.enableFlag(true)}else{if((!m&&r.connectStatus!="ppp_disconnected")||(m&&r.rj45ConnectStatus!="idle"&&r.rj45ConnectStatus!="dead")){j.enableFlag(false)}else{j.enableFlag(true)}}var s=(r.blc_wan_mode=="AUTO_PPP"||r.blc_wan_mode=="AUTO_PPPOE")?"AUTO":r.blc_wan_mode;var q="";switch(s){case"AUTO":q="opmode_auto";break;case"PPPOE":q="opmode_cable";break;case"PPP":q="opmode_gateway";break;default:break}f("#opmode").attr("data-trans",q).text(f.i18n.prop(q))};if(j.hasRj45){j.refreshOpmodeInfo();addInterval(function(){j.refreshOpmodeInfo()},1000)}j.enterPIN=function(){showLoading();j.page(j.pageState.LOADING);var q=j.PIN();c.enterPIN({PinNumber:q},function(r){if(!r.result){hideLoading();if(j.pinNumber()==2){showAlert("last_enter_pin",function(){k()})}else{showAlert("pin_error",function(){k()})}j.PIN("")}k();if(j.page()==j.pageState.WAIT_PUK){hideLoading()}})};j.enterPUK=function(){showLoading();j.page(j.pageState.LOADING);var s=j.newPIN();var q=j.confirmPIN();var r={};r.PinNumber=s;r.PUKNumber=j.PUK();c.enterPUK(r,function(t){if(!t.result){hideLoading();if(j.pukNumber()==2){showAlert("last_enter_puk",function(){k()})}else{showAlert("puk_error",function(){k();if(j.page()==j.pageState.PUK_LOCKED){hideLoading()}})}j.PUK("");j.newPIN("");j.confirmPIN("")}else{k();if(j.page()==j.pageState.PUK_LOCKED){hideLoading()}}})};function k(){var r=c.getLoginData();var q=i(r);if(q==j.pageState.LOADING){addTimeout(k,500)}else{j.page(q);j.pinNumber(r.pinnumber);j.pukNumber(r.puknumber)}}function i(r){var q=r.modem_main_state;if(q=="modem_sim_undetected"||q=="modem_undetected"||q=="modem_sim_destroy"){return j.pageState.NO_SIM}else{if(f.inArray(q,d.TEMPORARY_MODEM_MAIN_STATE)!=-1){return j.pageState.LOADING}else{if(q=="modem_waitpin"){return j.pageState.WAIT_PIN}else{if((q=="modem_waitpuk"||r.pinnumber==0)&&(r.puknumber!=0)){return j.pageState.WAIT_PUK}else{if((r.puknumber==0||q=="modem_sim_destroy")&&q!="modem_sim_undetected"&&q!="modem_undetected"){return j.pageState.PUK_LOCKED}else{location.reload()}}}}}}}function g(){var i=f("#container")[0];e.cleanNode(i);var j=new a();e.applyBindings(j,i);f("#frmPIN").validate({submitHandler:function(){j.enterPIN()},rules:{txtPIN:"pin_check"}});f("#frmPUK").validate({submitHandler:function(){j.enterPUK()},rules:{txtNewPIN:"pin_check",txtConfirmPIN:{equalToPin:"#txtNewPIN"},txtPUK:"puk_check"}})}return{init:g}});