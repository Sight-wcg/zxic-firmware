define(["jquery","knockout","config/config","service","underscore","config/menu","logout"],function(h,m,f,i,k,e,n){var j={LOGIN:0,WAIT_PIN:1,WAIT_PUK:2,PUK_LOCKED:3,LOGGEDIN:4,LOADING:5};var d=c();var g=0;function c(){return setInterval(function(){var o=i.getStatusInfo();if(!o.isLoggedIn){a();return}lastLoginStatus=i.getStatusInfo().isLoggedIn?"1":"0"},1000)}function b(){var w=this;var s=i.getLoginData();var q=i.getLoginStatus();w.password=m.observable();w.PIN=m.observable();w.PUK=m.observable();w.newPIN=m.observable();w.confirmPIN=m.observable();w.pinNumber=m.observable(s.pinnumber);w.pukNumber=m.observable(s.puknumber);w.loginCount=m.observable(0);w.loginSecuritySupport=m.observable(f.LOGIN_SECURITY_SUPPORT);w.leftSeconds=m.observable(0);w.accountLocked=m.computed(function(){return w.loginCount()==f.MAX_LOGIN_COUNT&&w.leftSeconds()!="-1"});w.uiLoginTimer=m.observable(300);w.leftUnlockTime=m.computed(function(){w.leftSeconds();var x=transSecond2Time(w.uiLoginTimer());return x.substring(x.indexOf(":")+1,x.length)});w.showEntrance=m.observable(false);w.sharePathInvalid=m.observable(false);if(f.SD_CARD_SUPPORT){i.getSDConfiguration({},function(x){w.showEntrance(x.sd_status=="1"&&x.share_status=="1"&&x.sd_mode=="0");if(w.showEntrance()){i.checkFileExists({path:x.share_file},function(y){if(y.status=="exist"||y.status=="processing"){w.sharePathInvalid(false)}else{w.sharePathInvalid(true)}})}})}var o=p(q,s);w.pageState=m.observable(o);if(o==j.LOADING){addTimeout(r,500)}u();w.login=function(){if(f.LOGIN_SECURITY_SUPPORT&&w.accountLocked()){showAlert("password_error_account_lock_time",function(){u()});return false}w.pageState(j.LOADING);window.clearInterval(d);i.login({password:w.password()},function(x){setTimeout(function(){d=c()},1300);if(x.result=="true"){w.pageState(j.LOGGEDIN);if(f.LOGIN_SECURITY_SUPPORT){w.loginCount(0);w.uiLoginTimer(300);clearInterval(g)}h("#container").empty();window.location.hash="#home";n.init()}else{if(x.result=="locked"){showAlert("iccid_locked",function(){u()});w.pageState(j.LOGIN)}else{if(x.result=="clean"){showOverLay("iccid_clean","overlay-success");w.pageState(j.LOGIN)}else{if(x.result=="reset"){showConfirm("restore_confirm",function(){i.superpasswordfactoryreset({},function(y){if(y.result=="success"){showOverLay("remo_factory_reset_success","overlay-success")}else{errorOverlay()}});w.password("")});w.pageState(j.LOGIN)}else{w.password("");if(f.LOGIN_SECURITY_SUPPORT){w.checkLoginData(function(){if(w.loginCount()==f.MAX_LOGIN_COUNT){showAlert("password_error_five_times",function(){u()});w.startLoginLockInterval()}else{showAlert({msg:"password_error_left",params:[f.MAX_LOGIN_COUNT-w.loginCount()]},function(){u()})}})}else{showAlert("password_error",function(){u()})}w.pageState(j.LOGIN)}}}}})};w.startLoginLockInterval=function(){g=setInterval(function(){i.getLoginData({},function(x){if(x.login_lock_time<=0||x.psw_fail_num_str==5){w.loginCount(0);clearInterval(g)}if(w.leftSeconds()!=x.login_lock_time){w.leftSeconds(x.login_lock_time);w.uiLoginTimer(x.login_lock_time)}else{w.uiLoginTimer(w.uiLoginTimer()>0?w.uiLoginTimer()-1:0)}})},1000)};w.checkLoginData=function(x){i.getLoginData({},function(z){var y=parseInt(z.psw_fail_num_str,10);w.loginCount(f.MAX_LOGIN_COUNT-y);w.leftSeconds(z.login_lock_time);w.uiLoginTimer(z.login_lock_time);if(h.isFunction(x)){x()}else{if(w.loginCount()==f.MAX_LOGIN_COUNT){w.startLoginLockInterval()}}})};w.checkLoginData();w.enterPIN=function(){w.pageState(j.LOADING);var x=w.PIN();i.enterPIN({PinNumber:x},function(y){if(!y.result){showAlert("pin_error",function(){r()});w.PIN("")}else{r()}})};w.enterPUK=function(){w.pageState(j.LOADING);var z=w.newPIN();var x=w.confirmPIN();var y={};y.PinNumber=z;y.PUKNumber=w.PUK();i.enterPUK(y,function(A){if(!A.result){showAlert("puk_error",function(){r()});w.PUK("");w.newPIN("");w.confirmPIN("")}else{r()}})};function r(){var z=i.getLoginData();var x=i.getLoginStatus();var y=p(x,z);if(y==j.LOADING){addTimeout(r,500)}else{w.pageState(y);w.pinNumber(z.pinnumber);w.pukNumber(z.puknumber)}u()}function u(){setTimeout(function(){var y=h("#txtPwd:visible");var x=h("#txtPIN:visible");var z=h("#txtPUK:visible");if(y.length>0){y.focus()}else{if(x.length>0){x.focus()}else{if(z.length>0){z.focus()}}}},100)}function p(x,y){if(f.LOGIN_THEN_CHECK_PIN){return v(x,y)}else{return t(x,y)}}function v(x,z){if(x.status=="loggedIn"){if(y=="modem_waitpin"){return j.WAIT_PIN}else{if((y=="modem_waitpuk"||z.pinnumber==0)&&(z.puknumber!=0)){return j.WAIT_PUK}else{if((z.puknumber==0||y=="modem_sim_destroy")&&y!="modem_sim_undetected"&&y!="modem_undetected"){return j.PUK_LOCKED}else{return j.LOGGEDIN}}}}else{var y=z.modem_main_state;if(h.inArray(y,f.TEMPORARY_MODEM_MAIN_STATE)!=-1){return j.LOADING}else{return j.LOGIN}}}function t(x,z){if(x.status=="loggedIn"){return j.LOGGEDIN}else{var y=z.modem_main_state;if(h.inArray(y,f.TEMPORARY_MODEM_MAIN_STATE)!=-1){return j.LOADING}else{if(y=="modem_waitpin"){return j.WAIT_PIN}else{if((y=="modem_waitpuk"||parseInt(z.pinnumber)===0)&&(parseInt(z.puknumber)!=0)){return j.WAIT_PUK}else{if((parseInt(z.puknumber)===0||y=="modem_sim_destroy")&&y!="modem_sim_undetected"&&y!="modem_undetected"){return j.PUK_LOCKED}else{return j.LOGIN}}}}}}}function l(){var q=i.getStatusInfo();if(q.isLoggedIn){window.location.hash="#home";return}var o=h("#container")[0];m.cleanNode(o);var p=new b();m.applyBindings(p,o);h("#frmLogin").validate({submitHandler:function(){p.login()},rules:{txtPwd:"login_password_length_check"}});h("#frmPIN").validate({submitHandler:function(){p.enterPIN()},rules:{txtPIN:"pin_check"}});h("#frmPUK").validate({submitHandler:function(){p.enterPUK()},rules:{txtNewPIN:"pin_check",txtConfirmPIN:{equalToPin:"#txtNewPIN"},txtPUK:"puk_check"}})}function a(){if(window.location.hash!=f.defaultRoute&&k.indexOf(f.GUEST_HASH,window.location.hash)==-1){if(!manualLogout&&lastLoginStatus=="1"){manualLogout=false;lastLoginStatus="UNREAL";showAlert("need_login_again",function(){window.location="index.html"})}else{if(lastLoginStatus=="UNREAL"){return}else{window.location="index.html"}}}}return{init:l,gotoLogin:a}});