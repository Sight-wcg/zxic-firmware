define(["underscore","jquery","knockout","config/config","service","lib/jquery/chosen.jquery"],function(Y,B,T,G,d,K){var n=1;var f=false,O=false;var Q=null,s=null,x=null,c=null,m=[],u=[],i={},D={},v=true;function R(Z){return d.getSMSMessages({page:0,smsCount:500,nMessageStoreType:1,tags:10,orderBy:"order by id desc"},function(aa){tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),aa.messages.length);G.dbMsgs=aa.messages;G.listMsgs=k(G.dbMsgs);Z()},function(){tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),0);G.dbMsgs=[];G.listMsgs=[];cleanSmsList()})}cleanSmsList=function(){B("#smslist-table").empty()};function k(aa){var Z={},ab=[];G.listMsgs=[];m=[];B.each(aa,function(ac,ae){if(ae.tag=="4"&&ae.groupId!=""){m.push(ae);return}ae.target=ae.number;if(parseInt(ae.id,10)>G.smsMaxId){G.smsMaxId=ae.id}var ad=getLastNumber(ae.number,G.SMS_MATCH_LENGTH);if(ad in Z){Z[ad].push(ae)}else{Z[ad]=[ae];ab.push(ae)}});ab=Y.sortBy(ab,function(ac){return 0-parseInt(ac.id+"",10)});B.each(ab,function(ah,af){var ad=getLastNumber(af.number,G.SMS_MATCH_LENGTH);var ae=0;var ag=false;for(var ac=0;ac<Z[ad].length;ac++){if(Z[ad][ac].isNew){ae++}if(Z[ad][ac].tag=="4"&&Z[ad][ac].groupId==""){ag=true}}G.listMsgs.push({id:Z[ad][0].id,name:"",number:Z[ad][0].number,latestId:Z[ad][0].id,totalCount:Z[ad].length,newCount:ae,latestSms:Z[ad][0].content,latestTime:Z[ad][0].time,checked:false,itemId:getLastNumber(ad,G.SMS_MATCH_LENGTH),groupId:Z[ad][0].groupId,hasDraft:ag})});return G.listMsgs}function M(){var Z=d.getPhoneBooks({page:0,data_per_page:2000,orderBy:"name",isAsc:true});if(B.isArray(Z.pbm_data)&&Z.pbm_data.length>0){G.phonebook=Z.pbm_data}E()}function E(){var ah=B("#chosenUserList .chosen-select-deselect");ah.empty();var Z=[];var an=[];var ao=[];for(var aj=0;aj<G.phonebook.length;aj++){var ad=G.phonebook[aj];var aa=getLastNumber(ad.pbm_number,G.SMS_MATCH_LENGTH);if(aa&&B.inArray(aa,ao)==-1){Z.push(new Option(ad.pbm_name+"/"+ad.pbm_number,aa,false,true));if(B.inArray(aa,an)==-1){an.push(aa)}ao.push(aa)}else{for(var ak=0;ak<Z.length;ak++){if(Z[ak].value==aa){Z[ak].text=ad.pbm_name+"/"+ad.pbm_number;break}}}}var af=[];for(var ai=0;ai<m.length;ai++){if(B.inArray(m[ai].groupId,af)==-1){af.push(m[ai].groupId);var ag=m[ai];i[m[ai].groupId]=[ag]}else{var ag=m[ai];i[m[ai].groupId].push(ag)}var ac=getLastNumber(m[ai].number,G.SMS_MATCH_LENGTH);if(B.inArray(ac,an)==-1){Z.push(new Option(m[ai].number,ac));an.push(ac)}}for(var am in i){var ab=i[am];var ap=ab[ab.length-1];ap.draftShowName="";ap.draftShowNameTitle="";B.each(ab,function(ar,au){var at=getShowNameByNumber(au.number);ap.draftShowName+=(ar==0?"":";")+at;ap.draftShowNameTitle+=(ar==0?"":";")+at});var al=10;if(getEncodeType(ap.draftShowName).encodeType=="UNICODE"){al=10}ap.draftShowName=ap.draftShowName.length>al?ap.draftShowName.substring(0,al)+"...":ap.draftShowName;ap.totalCount=ab.length;ap.hasDraft=true;ap.latestTime=ap.time;u.push(ap)}for(var ak=0;ak<G.listMsgs.length;ak++){var aq=G.listMsgs[ak];for(var aj=G.phonebook.length;aj>0;aj--){var ad=G.phonebook[aj-1];var aa=getLastNumber(ad.pbm_number,G.SMS_MATCH_LENGTH);if(aq.itemId==aa){aq.name=ad.pbm_name;for(var ai=0;ai<Z.length;ai++){if(aa==Z[ai].value){Z[ai].value=getLastNumber(aq.number,G.SMS_MATCH_LENGTH);Z[ai].text=ad.pbm_name+"/"+aq.number;break}}break}}if(B.inArray(aq.itemId,an)==-1){Z.push(new Option(aq.number,getLastNumber(aq.number,G.SMS_MATCH_LENGTH)));an.push(aq.itemId)}}var ae="";B.each(Z,function(ar,at){ae+="<option value='"+at.value+"'>"+at.text+"</option>"});ah.append(ae);ah.chosen({max_selected_options:5,search_contains:true,width:"740px"});A();X();f=true}function A(){if(s==null){s=B.template("smsTableTmpl",B("#smsTableTmpl"))}cleanSmsList();B.tmpl("smsTableTmpl",{data:G.listMsgs}).translate().appendTo("#smslist-table");if(G.HAS_PHONEBOOK){B(".sms-add-contact-icon").removeClass("hide")}else{B(".sms-add-contact-icon").addClass("hide")}}function X(){if(u.length==0){return false}if(s==null){s=B.template("smsTableTmpl",B("#smsTableTmpl"))}B.tmpl("smsTableTmpl",{data:u}).translate().prependTo("#smslist-table")}function h(){var Z=[];var aa=Y.range((n-1)*5,n*5);B.each(aa,function(ab,ac){if(G.listMsgs[ac]){Z.push(G.listMsgs[ac])}});n++;if(s==null){s=B.template("smsTableTmpl",B("#smsTableTmpl"))}B.tmpl("smsTableTmpl",{data:Z}).translate().appendTo("#smslist-table");renderCheckbox();if(Z.length==0){disableBtn(B("#smslist-delete-all"));tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),0)}else{enableBtn(B("#smslist-delete-all"));tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),1)}if(n==2&&window.innerHeight==B("body").height()){h()}return Z}checkboxClickHandler=function(Z){checkDeleteBtnStatus()};getSelectedItem=function(){var aa=[];var Z=B("#smslist-table input:checkbox:checked");Z.each(function(ab,ac){aa.push(B(ac).val())});return aa};checkDeleteBtnStatus=function(){var Z=getSelectedItem().length;if(Z==0){disableBtn(B("#smslist-delete"))}else{enableBtn(B("#smslist-delete"))}};refreshClickHandler=function(){B("#smslist-table").empty();disableBtn(B("#smslist-delete"));disableCheckbox(B("#smslist-checkAll","#smsListForm"));P();renderCheckbox()};deleteAllClickHandler=function(){showConfirm("confirm_data_delete",function(){showLoading("deleting");d.deleteAllMessages({location:"native_inbox"},function(Z){cleanSmsList();tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),0);successOverlay()},function(Z){errorOverlay(Z.errorText)})})};deleteSelectClickHandler=function(){showConfirm("confirm_sms_delete",function(){showLoading("deleting");var ab=Z();d.deleteMessage({ids:ab.ids},function(ac){aa(ab);disableBtn(B("#smslist-delete"));B("#checkbox-all").removeAttr("checked");renderCheckbox();successOverlay()},function(ac){errorOverlay(ac.errorText)})});function aa(ab){var ac=ab.ids;var ad=[];B.each(G.dbMsgs,function(ae,af){if(B.inArray(af.id,ab.normalIds)!=-1){ad.push(af.number)}});ad=Y.uniq(ad);B.each(ad,function(ae,af){B("#smslist-item-"+getLastNumber(af,G.SMS_MATCH_LENGTH)).hide().remove()});B.each(ab.groups,function(ae,af){B("#smslist-item-"+af).hide().remove()});synchSmsList(ad,ac)}function Z(){var af=[];var ac=[];var ad=[];var ab=[];var ae=getSelectedItem();B.each(ae,function(ag,ai){var ah=B("#checkbox"+ai);if(ah.attr("groupid")){ab.push(ah.attr("groupid"))}else{af.push(getLastNumber(ah.attr("number"),G.SMS_MATCH_LENGTH))}});B.each(G.dbMsgs,function(ag,ah){if(B.inArray(getLastNumber(ah.number,G.SMS_MATCH_LENGTH),af)!=-1&&(typeof ah.groupId=="undefined"||Y.isEmpty(ah.groupId+""))){ac.push(ah.id);ad.push(ah.id)}else{if(B.inArray(ah.groupId+"",ab)!=-1){ac.push(ah.id)}}});ac=Y.uniq(ac);return{ids:ac,groups:ab,normalIds:ad}}};newMessageClickHandler=function(){B("#chosenUser1","#smsChatRoom").addClass("hide");B("#chosenUser","#smsChatRoom").show();cleanChatInput();H();B("select.chosen-select-deselect").val("").trigger("chosen:updated.chosen");C("chat");gotoBottom();clearChatList()};chatCancelClickHandler=function(){if(G.CONTENT_MODIFIED.modified){var ab="sms_to_save_draft";var Z=syncSelectAndChosen(B("select#chosenUserSelect"),B(".search-choice","#chosenUserSelect_chosen"));var aa=!Z||Z.length==0;if(aa){ab="sms_no_recipient"}if(aa){showConfirm(ab,{ok:function(){if(!aa){F({content:B("#chat-input","#smsChatRoom").val(),numbers:Z,isFromBack:true})}G.resetContentModifyValue();q()},no:function(){if(aa){return true}G.resetContentModifyValue();q()}})}else{F({content:B("#chat-input","#smsChatRoom").val(),numbers:Z,isFromBack:true});G.resetContentModifyValue();q()}return false}q()};toOtherClickHandler=function(Z){G.CONTENT_MODIFIED.checkChangMethod();if(G.CONTENT_MODIFIED.modified){N();if(G.CONTENT_MODIFIED.message=="sms_to_save_draft"){G.CONTENT_MODIFIED.callback.ok(G.CONTENT_MODIFIED.data);G.resetContentModifyValue();window.location.hash=Z}else{showConfirm(G.CONTENT_MODIFIED.message,{ok:function(){G.CONTENT_MODIFIED.callback.ok(G.CONTENT_MODIFIED.data);G.resetContentModifyValue();window.location.hash=Z},no:function(){var aa=G.CONTENT_MODIFIED.callback.no(G.CONTENT_MODIFIED.data);if(!aa){window.location.hash=Z;G.resetContentModifyValue()}}})}return false}else{window.location.hash=Z}};function q(){B("select.chosen-select-deselect").val("").trigger("chosen:updated.chosen");G.currentChatObject=null;B(".smslist-btns","#smslist-main").removeClass("smsListFloatButs");C("list")}function C(Z){if(Z=="chat"){B("#smslist-main").hide();B("#smsChatRoom").show()}else{B("#smsChatRoom").hide();B("#smslist-main").show()}}var r=null;addSendSmsError=function(Z){if(r){window.clearTimeout(r);r=null}B("#sendSmsErrorLi").text(B.i18n.prop(Z));r=addTimeout(function(){B("#sendSmsErrorLi").text("")},5000)};sendSmsClickHandler=function(){if(!v){showAlert("sms_capacity_is_full_for_send");return}var aa=B("#chat-input","#smsChatRoom");var ad=aa.val();if(ad==B.i18n.prop("chat_input_placehoder")){aa.val("");ad=""}var ac=syncSelectAndChosen(B("select#chosenUserSelect"),B(".search-choice","#chosenUserSelect_chosen"));if(B.isArray(ac)){ac=B.grep(ac,function(af,ae){return !Y.isEmpty(af)})}if(!ac||ac.length==0){addSendSmsError("sms_contact_required");return}if(ac.length+D.nvUsed>D.nvTotal){showAlert({msg:"sms_capacity_will_full_just",params:[D.nvTotal-D.nvUsed]});return}if(ac.length==1){G.currentChatObject=getLastNumber(ac[0],G.SMS_MATCH_LENGTH);showLoading("sending")}else{if(ac.length>1){showLoading("sending","<button id='sms_cancel_sending' onclick='cancelSending()' class='btn btn-primary'>"+B.i18n.prop("sms_stop_sending")+"</button>");G.currentChatObject=null}}var Z=0;var ab=ac.length;V=true;disableBtn(B("#btn-send","#inputpanel"));sendSms=function(){if(!V){hideLoading();return}var ae={id:-1,number:ac[Z],content:ad,isNew:false};if(ab==1){B("#loading #loading_container").html("")}ab--;d.sendSMS({number:ae.number,message:ae.content,id:-1},function(ag){var af=getLatestMessage()||{id:parseInt(G.smsMaxId,10)+1,time:transUnixTime(B.now()),number:ae.number};G.smsMaxId=af.id;ae.id=G.smsMaxId;ae.time=af.time;ae.tag=2;ae.hasDraft=false;if(ac.length>1){ae.targetName=getNameOrNumberByNumber(ae.number)}addSendMessage(ae,Z+1!=ac.length);S(ae);e(ae);tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length);gotoBottom();if(Z+1==ac.length){updateChatInputWordLength();enableBtn(B("#btn-send","#inputpanel"));hideLoading();return}Z++;sendSms()},function(af){var ag=getLatestMessage()||{id:parseInt(G.smsMaxId,10)+1,time:transUnixTime(B.now()),number:ae.number};G.smsMaxId=ag.id;ae.id=G.smsMaxId;ae.time=ag.time;ae.errorText=B.i18n.prop(af.errorText);ae.tag=3;ae.target=ae.number;ae.hasDraft=false;if(ac.length>1){ae.targetName=getNameOrNumberByNumber(ae.number)}addSendMessage(ae,Z+1!=ac.length);S(ae);e(ae);tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length);gotoBottom();if(Z+1==ac.length){updateChatInputWordLength();enableBtn(B("#btn-send","#inputpanel"));hideLoading();return}Z++;sendSms()})};sendSms()};var V=true;cancelSending=function(){V=false;B("#loading #loading_container").html(B.i18n.prop("sms_cancel_sending"))};getLatestMessage=function(){var aa=d.getSMSMessages({page:0,smsCount:5,nMessageStoreType:1,tags:10,orderBy:"order by id desc"});if(aa.messages.length>0){for(var Z=0;Z<aa.messages.length;Z++){if(aa.messages[Z].tag=="2"||aa.messages[Z].tag=="3"){return aa.messages[Z]}}return null}else{return null}};function S(ab){if(G.dbMsgs.length==0){G.dbMsgs=[ab]}else{for(var aa=0;aa<G.dbMsgs.length;aa++){if(G.dbMsgs[aa].id==ab.id){G.dbMsgs[aa]=ab;return}else{var Z=[ab];B.merge(Z,G.dbMsgs);G.dbMsgs=Z;return}}}}function e(ab,ac,Z){if((!ab||!ab.number)&&!ac){return}var ag="";if(ab&&typeof ab.groupId!="undefined"&&ab.groupId!=""){ag=ab.groupId}else{ag=getLastNumber((ac||ab.number),G.SMS_MATCH_LENGTH)}var ai=B("#smslist-item-"+ag);if(ai&&ai.length>0){var aa=ai.find(".smslist-item-total-count");var ae=aa.text();ae=Number(ae.substring(1,ae.length-1));if(ac){if(ae==1||ab==null){ai.hide().remove();return}else{aa.text("("+(ae-(Z||1))+")");ai.find(".smslist-item-draft-flag").addClass("hide")}}else{aa.text("("+(ae+1)+")");if(ab.tag=="4"){ai.find(".smslist-item-draft-flag").removeClass("hide")}}ai.find(".smslist-item-checkbox p.checkbox").attr("id",ab.id);ai.find(".smslist-item-checkbox input:checkbox").val(ab.id).attr("id","checkbox"+ab.id);var af=ab.content;if(ab.tag=="4"){af='<span class="smslist-item-draft-flag colorRed" data-trans="draft"></span>: '+af}var ad=ai.find(".smslist-item-msg").html(af);ad.closest("td").prop("title",ab.content);ai.find(".smslist-item-repeat span").die().click(function(){forwardClickHandler(ab.id)});ai.find("span.clock-time").text(ab.time);var ah=ai;ai.hide().remove();B("#smslist-table").prepend(ah.show())}else{if(s==null){s=B.template("smsTableTmpl",B("#smsTableTmpl"))}ab.checked=false;ab.newCount=0;ab.latestId=ab.id;ab.latestSms=ab.content;ab.latestTime=ab.time;if(ab.groupId==""||typeof ab.groupId=="undefined"){ab.totalCount=1}if(!ab.hasDraft){ab.hasDraft=false}ab.itemId=ag;ab.name=getNameByNumber(ab.number);B.tmpl("smsTableTmpl",{data:[ab]}).translate().prependTo("#smslist-table")}if(G.HAS_PHONEBOOK){B(".sms-add-contact-icon").removeClass("hide")}else{B(".sms-add-contact-icon").addClass("hide")}B("#smslist-table").translate();renderCheckbox()}addSendMessage=function(Z,aa){if(c==null){c=B.template("smsMeTmpl",B("#smsMeTmpl"))}B.tmpl("smsMeTmpl",Z).appendTo("#chatlist");B("#chatlist").translate();if(!aa){cleanChatInput()}clearMySmsErrorMessage(Z.id)};clearMySmsErrorMessage=function(Z){addTimeout(function(){B("div.error","#talk-item-"+Z).text("")},3000)};var p=false;hidePopup=function(){B(".tagPopup").remove();p=false};clearChatList=function(){B("#chatlist").empty();updateChatInputWordLength()};dealContent=function(Z){if(G.HAS_PHONEBOOK){return HTMLEncode(Z).replace(/(\d{3,})/g,function(ab){var aa=(new Date().getTime()+"").substring(6)+(getRandomInt(1000)+1000);return"<a id='aNumber"+aa+"' href='javascript:openPhoneBook(\""+aa+'", "'+ab+"\")'>"+ab+"</a>"})}else{return HTMLEncode(Z)}};openPhoneBook=function(Z,ad){var ag=null;var af="";var ae=null;var ac=false;if(!Z){ag=B("#listNumber"+getLastNumber(ad,G.SMS_MATCH_LENGTH));af=".smslist-item";ae=B("#addPhonebookContainer")}else{ag=B("#aNumber"+Z);af=".msg_container";ae=B("#chatlist");ac=true}if(p){hidePopup()}p=true;B("#tagPopup").remove();if(Q==null){Q=B.template("addPhonebookTmpl",B("#addPhonebookTmpl"))}B.tmpl("addPhonebookTmpl",{number:ad}).appendTo(ae);var aa=ag.position();var am=ag.closest(af);var ab=am.position();var al=0,aj=0;if(ac){var ah=ae.width();var ak=ae.height();var ai=B("#innerTagPopup");al=ab.left+aa.left;aj=ab.top+aa.top+20;if(ai.width()+al>ah){al=ah-ai.width()-20}if(ak>100&&ai.height()+aj>ak){aj=ak-ai.height()-5}}else{al=aa.left;aj=aa.top}B("#innerTagPopup").css({top:aj+"px",left:al+"px"});B("#quickSaveContactForm").translate().validate({submitHandler:function(){quickSaveContact(ac)},rules:{name:"name_check",number:"phonenumber_check"}})};quickSaveContact=function(){var Z=B(".tagPopup #innerTagPopup #name").val();var ac=B(".tagPopup #innerTagPopup #number").val();var ab={index:-1,location:1,name:Z,mobile_phone_number:ac,home_phone_number:"",office_phone_number:"",mail:""};var aa=d.getDevicePhoneBookCapacity();if(aa.pcPbmUsedCapacity>=aa.pcPbmTotalCapacity){showAlert("device_full");return false}showLoading("waiting");d.savePhoneBook(ab,function(ad){if(ad.result=="success"){G.phonebook.push({pbm_name:Z,pbm_number:ac});t(Z,ac);hidePopup();successOverlay()}else{errorOverlay()}},function(ad){errorOverlay()})};function t(aa,ab){var Z=getLastNumber(ab,G.SMS_MATCH_LENGTH);B("span.smslist-item-name2","#smslist-item-"+Z).text(aa);B("#listNumber"+Z).hide()}deleteSingleItemClickHandler=function(ab,Z){if(Z){aa(ab)}else{showConfirm("confirm_sms_delete",function(){showLoading("deleting");aa(ab)})}function aa(ac){d.deleteMessage({ids:[ac]},function(ad){var ae=B(".smslist-item-delete","#talk-item-"+ac).attr("target");B("#talk-item-"+ac).hide().remove();synchSmsList(null,[ac]);e(getPeopleLatestMsg(ae),ae);if(Z){Z()}else{hideLoading()}tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length)},function(ad){if(Z){Z()}else{hideLoading()}})}};function g(aa,Z){z();d.deleteMessage({ids:aa},function(ac){j(null,function(){N();U()});for(var ab=0;ab<Z.length;ab++){e(getPeopleLatestMsg(Z[ab]),Z[ab],aa.length)}synchSmsList(null,aa);tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length)},function(ab){U()})}function J(aa,Z){d.deleteMessage({ids:aa},function(ab){synchSmsList(null,aa);B("#smslist-item-"+Z).hide().remove();H();tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length)},function(ab){})}getCurrentChatObject=function(){var Z=B("select.chosen-select-deselect").val();if(!Z){G.currentChatObject=null}else{if(Z.length==1){G.currentChatObject=getLastNumber(Z,G.SMS_MATCH_LENGTH)}else{if(Z.length>1){G.currentChatObject=null}}}return G.currentChatObject};getPeopleLatestMsg=function(aa){for(var Z=0;Z<G.dbMsgs.length;Z++){if(!G.dbMsgs[Z].groupId&&getLastNumber(G.dbMsgs[Z].number,G.SMS_MATCH_LENGTH)==getLastNumber(aa,G.SMS_MATCH_LENGTH)){return G.dbMsgs[Z]}}return null};resendClickHandler=function(ad){if(!v){showAlert("sms_capacity_is_full_for_send");return}showLoading("sending");B("div.error","#talk-item-"+ad).text(B.i18n.prop("sms_resending"));var ac=B("div.smslist-item-resend","#talk-item-"+ad).attr("target");var ab=B("div.J_content","#talk-item-"+ad).text();for(var aa=0;aa<G.dbMsgs.length;aa++){if(G.dbMsgs[aa].id==ad){ab=G.dbMsgs[aa].content}}disableBtn(B("#btn-send","#inputpanel"));var Z={id:-1,number:ac,content:ab,isNew:false};d.sendSMS({number:Z.number,message:Z.content,id:-1},function(af){var ae=getLatestMessage()||{id:parseInt(G.smsMaxId,10)+1,time:transUnixTime(B.now()),number:Z.number};G.smsMaxId=ae.id;Z.id=G.smsMaxId;Z.time=ae.time;Z.tag=2;Z.target=ae.number;Z.targetName=getNameOrNumberByNumber(ac);S(Z);e(Z);deleteSingleItemClickHandler(ad,function(){addSendMessage(Z,true);updateChatInputWordLength();enableBtn(B("#btn-send","#inputpanel"));hideLoading();gotoBottom()})},function(ae){var af=getLatestMessage()||{id:parseInt(G.smsMaxId,10)+1,time:transUnixTime(B.now()),number:Z.number};G.smsMaxId=af.id;Z.id=G.smsMaxId;Z.time=af.time;Z.errorText=B.i18n.prop("sms_resend_fail");Z.tag=3;Z.target=af.number;Z.targetName=getNameOrNumberByNumber(ac);S(Z);e(Z);deleteSingleItemClickHandler(ad,function(){addSendMessage(Z,true);updateChatInputWordLength();enableBtn(B("#btn-send","#inputpanel"));hideLoading();gotoBottom()})})};gotoBottom=function(){B("#chatpanel .clear-container").animate({scrollTop:B("#chatlist").height()})};var L=0;var W=false;function o(){n=1;G.dbMsgs=[];G.listMsgs=null;G.smsMaxId=0;G.phonebook=[];f=false;shownMsgs=[];W=false;L=0;m=u=[];i={}}function I(){showLoading("waiting");G.currentChatObject=null;var Z=function(){d.getSMSReady({},function(ac){if(ac.sms_cmd_status_result=="2"){B("input:button","#smsListForm .smslist-btns").attr("disabled","disabled");hideLoading();showAlert("sms_init_fail")}else{if(ac.sms_cmd_status_result=="1"){addTimeout(Z,1000)}else{if(G.HAS_PHONEBOOK){ab()}else{aa(false)}}}})};var ab=function(){d.getPhoneBookReady({},function(ac){if(ac.pbm_init_flag=="6"){aa(false)}else{if(ac.pbm_init_flag!="0"){addTimeout(ab,1000)}else{aa(true)}}})};var aa=function(ac){o();if(ac){R(function(){M();hideLoading()})}else{R(function(){G.phonebook=[];E();hideLoading()})}bindingEvents();a();window.scrollTo(0,0);y()};Z()}function y(){var Z=B("#smsCapability");j(Z);b();addInterval(function(){j(Z);b()},5000)}function b(){var Z=d.getStatusInfo();if(Z.simStatus!="modem_init_complete"){disableBtn(B("#btn-send"));B("#sendSmsErrorLi").html('<span data-trans="no_sim_card_message">'+B.i18n.prop("no_sim_card_message")+"</span>");B("#chatpanel .smslist-item-resend:visible").hide()}else{enableBtn(B("#btn-send"));B("#chatpanel .smslist-item-resend:hidden").show()}}function j(Z,aa){d.getSmsCapability({},function(ab){if(Z!=null){Z.text("("+(ab.nvUsed>ab.nvTotal?ab.nvTotal:ab.nvUsed)+"/"+ab.nvTotal+")")}v=ab.nvUsed<ab.nvTotal;D=ab;if(B.isFunction(aa)){aa()}})}function P(){I()}bindingEvents=function(){var ab=B(window);var aa=B("#smslist-main .smslist-btns");var Z=B("#mainContainer").offset().top;ab.unbind("scroll").scroll(function(){if(ab.scrollTop()>Z){aa.addClass("smsListFloatButs marginnone")}else{aa.removeClass("smsListFloatButs marginnone")}});B("#smslist-table p.checkbox").die().live("click",function(){checkboxClickHandler(B(this).attr("id"))});B("#smslist-checkAll","#smsListForm").die().live("click",function(){checkDeleteBtnStatus()});B("#chat-input","#smsChatRoom").die().live("drop",function(){B("#inputpanel .chatform").addClass("chatformfocus");var ac=B(this);ac.removeAttr("data-trans");if(ac.val()==B.i18n.prop("chat_input_placehoder")){ac.val("")}updateChatInputWordLength()}).live("focusin",function(){B("#inputpanel .chatform").addClass("chatformfocus");var ac=B(this);ac.removeAttr("data-trans");if(ac.val()==B.i18n.prop("chat_input_placehoder")){ac.val("")}updateChatInputWordLength()}).live("focusout",function(){B("#inputpanel .chatform").removeClass("chatformfocus");var ac=B(this);if(ac.val()==""||ac.val()==B.i18n.prop("chat_input_placehoder")){ac.val(B.i18n.prop("chat_input_placehoder")).attr("data-trans","chat_input_placehoder")}updateChatInputWordLength()}).live("keyup",function(){updateChatInputWordLength()}).live("paste",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("cut",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("drop",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("contextmenu",function(){return false});B("#name").die().live("drop",function(){updateNameInputWordLength()}).live("focusin",function(){updateNameInputWordLength()}).live("focusout",function(){updateNameInputWordLength()}).live("keyup",function(){updateNameInputWordLength()}).live("paste",function(){updateNameInputWordLength()}).live("cut",function(){updateNameInputWordLength()}).live("dragend",function(){updateNameInputWordLength()}).live("contextmenu",function(){return false});B("select.chosen-select-deselect","#smsChatRoom").die().live("change",function(){N()});B("#searchInput").die().live("blur",function(){searchTextBlur()}).live("keyup",function(){updateSearchValue(B("#searchInput").val())})};updateNameInputWordLength=function(){var ab=B("#name","#quickSaveContactForm");var ac=ab[0];var ad=ab.val();var aa=getEncodeType(ad);var Z=aa.encodeType=="UNICODE"?11:22;while(ad.length+aa.extendLen>Z){ad=ad.substring(0,ad.length-1);ac.value=ad;aa=getEncodeType(ad);Z=aa.encodeType=="UNICODE"?11:22}};getShowNameByNumber=function(Z){for(var aa=G.phonebook.length;aa>0;aa--){if(getLastNumber(G.phonebook[aa-1].pbm_number,G.SMS_MATCH_LENGTH)==getLastNumber(Z,G.SMS_MATCH_LENGTH)){return G.phonebook[aa-1].pbm_name}}return Z};getNameByNumber=function(Z){for(var aa=G.phonebook.length;aa>0;aa--){if(getLastNumber(G.phonebook[aa-1].pbm_number,G.SMS_MATCH_LENGTH)==getLastNumber(Z,G.SMS_MATCH_LENGTH)){return G.phonebook[aa-1].pbm_name}}return""};getNameOrNumberByNumber=function(Z){for(var aa=G.phonebook.length;aa>0;aa--){if(G.phonebook[aa-1].pbm_number==Z){return G.phonebook[aa-1].pbm_name}}for(var aa=G.phonebook.length;aa>0;aa--){if(getLastNumber(G.phonebook[aa-1].pbm_number,G.SMS_MATCH_LENGTH)==getLastNumber(Z,G.SMS_MATCH_LENGTH)){return G.phonebook[aa-1].pbm_name}}return Z};smsItemClickHandler=function(ai){if(O){return false}O=true;if(x==null){x=B.template("smsOtherTmpl",B("#smsOtherTmpl"))}if(c==null){c=B.template("smsMeTmpl",B("#smsMeTmpl"))}var Z=getShowNameByNumber(ai);B("#chosenUser","#smsChatRoom").hide();B("#chosenUser1","#smsChatRoom").addClass("hide");G.currentChatObject=getLastNumber(ai,G.SMS_MATCH_LENGTH);setAsRead(ai);cleanChatInput();clearChatList();var ah=B("select.chosen-select-deselect","#smsChatRoom");var ac=B("option",ah);var aa=false;for(var ag=0;ag<ac.length;ag++){var ad=ac[ag];if(getLastNumber(ad.value,G.SMS_MATCH_LENGTH)==G.currentChatObject){ai=ad.value;aa=true;break}}if(!aa){ah.append("<option value='"+ai+"' selected='selected'>"+ai+"</option>")}B("select.chosen-select-deselect").val(ai).trigger("chosen:updated.chosen");C("chat");G.dbMsgs=Y.sortBy(G.dbMsgs,function(al){return 0-al.id});var aj=[];var ab=[];var ae=[];var af=false;for(var ag=G.dbMsgs.length-1;ag>=0;ag--){var ak=G.dbMsgs[ag];if(Y.indexOf(ae,ak.id)!=-1){continue}if(getLastNumber(ak.number,G.SMS_MATCH_LENGTH)==G.currentChatObject&&Y.isEmpty(ak.groupId)){ak.isNew=false;ak.errorText="";ak.targetName="";if(ak.tag=="0"||ak.tag=="1"){B.tmpl("smsOtherTmpl",ak).appendTo("#chatlist");ae.push(ak.id);ab.push(ak)}else{if(ak.tag=="2"||ak.tag=="3"){B.tmpl("smsMeTmpl",ak).appendTo("#chatlist");ae.push(ak.id);ab.push(ak)}else{if(ak.tag=="4"){aj.push(ak.id);B("#chat-input","#smsChatRoom").val(ak.content).removeAttr("data-trans");updateChatInputWordLength();af=true}}}}else{ae.push(ak.id);ab.push(ak)}}B("#chatlist").translate();if(af){B("#chosenUser","#smsChatRoom").show();B("#chosenUser1","#smsChatRoom").addClass("hide")}else{B("#chosenUser","#smsChatRoom").hide();B("#chosenUser1","#smsChatRoom").removeClass("hide").html(Z)}G.dbMsgs=ab.reverse();if(aj.length>0){g(aj,[ai])}else{H()}b();gotoBottom();O=false};function H(){var Z=B("#smsCapability");j(Z);addTimeout(function(){if(!v){showAlert("sms_capacity_is_full_for_send")}},2000)}cleanChatInput=function(){B("#chat-input","#smsChatRoom").val(B.i18n.prop("chat_input_placehoder")).attr("data-trans","chat_input_placehoder")};setAsRead=function(Z){var aa=[];B.each(G.dbMsgs,function(ab,ac){if(getLastNumber(ac.number,G.SMS_MATCH_LENGTH)==getLastNumber(Z,G.SMS_MATCH_LENGTH)&&ac.isNew){aa.push(ac.id);ac.isNew=false}});if(aa.length>0){d.setSmsRead({ids:aa},function(ab){if(ab.result){B("#smslist-item-"+getLastNumber(Z,G.SMS_MATCH_LENGTH)+" .smslist-item-new-count").text("").addClass("hide");B("#smslist-item-"+getLastNumber(Z,G.SMS_MATCH_LENGTH)).removeClass("font-weight-bold");B("#smslist-item-"+getLastNumber(Z,G.SMS_MATCH_LENGTH)+" td:nth-child(2)").removeClass("font-weight-bold")}B.each(G.listMsgs,function(ac,ad){if(ad.number==Z&&ad.newCount>0){ad.newCount=0}})})}};forwardClickHandler=function(ae){var ad=syncSelectAndChosen(B("select#chosenUserSelect"),B(".search-choice","#chosenUserSelect_chosen"));var ac=B("#chat-input","#smsChatRoom").val();var aa=typeof ac!="undefined"&&ac!=""&&ac!=B.i18n.prop("chat_input_placehoder");if(aa){F({content:ac,numbers:ad,isFromBack:true,noLoading:true})}clearChatList();G.currentChatObject=null;B("#chosenUser1","#smsChatRoom").addClass("hide");B("#chosenUser","#smsChatRoom").show();for(var ab=0;ab<G.dbMsgs.length;ab++){if(G.dbMsgs[ab].id==ae){var Z=B("#chat-input","#smsChatRoom");Z.val(G.dbMsgs[ab].content);setInsertPos(Z[0],G.dbMsgs[ab].content.length)}}updateChatInputWordLength();B("select.chosen-select-deselect").val("").trigger("chosen:updated.chosen");addTimeout(function(){B("#chosen-search-field-input").focus()},300);C("chat");gotoBottom()};updateChatInputWordLength=function(){var an=B("#chat-input","#smsChatRoom");var al=an[0];var ap=an.val();var ar=getEncodeType(ap);var af=ar.encodeType=="UNICODE"?335:765;if(ap.length+ar.extendLen>af){var aa=al.scrollTop;var Z=getInsertPos(al);var ai=ap.length+ar.extendLen-af;var ae=ap.substr(Z-ai>0?Z-ai:0,ai);var ab=ae.split("").reverse();var ak=0;var ad=0;for(var am=0;am<ab.length;am++){if(getEncodeType(ab[am]).extendLen>0){ak+=2}else{ak++}if(ak>=ai){ad=am+1;break}}var aq=Z-ad;al.value=ap.substr(0,aq)+ap.substr(Z);if(al.value.length>af){al.value=al.value.substr(0,af)}setInsertPos(al,aq);al.scrollTop=aa}var aj=0;var ah=B(al).val();var at={encodeType:"GSM7_default",extendLen:0};if(ah!=B.i18n.prop("chat_input_placehoder")){at=getEncodeType(ah)}var ao=at.encodeType=="UNICODE"?335:765;var ac=B("#inputcount","#inputpanel");var ag=B("#inputItemCount","#inputpanel");if(ah.length+at.extendLen>=ao){ac.addClass("colorRed");ag.addClass("colorRed")}else{B("#inputcount","#inputpanel").removeClass("colorRed");B("#inputItemCount","#inputpanel").removeClass("colorRed")}if(""!=ah&&B.i18n.prop("chat_input_placehoder")!=ah){aj=ah.length+at.extendLen}ac.html("("+aj+"/"+ao+")");ag.html("("+getSmsCount(ah)+"/5)");N()};function N(){var aa=B("#chat-input","#smsChatRoom").val();if(v){var ab=getSelectValFromChosen(B(".search-choice","#chosenUserSelect_chosen"));var ac=!ab||ab.length==0;var Z=typeof aa!="undefined"&&aa!=""&&aa!=B.i18n.prop("chat_input_placehoder");if(!Z){G.resetContentModifyValue();return}if(Z&&!ac){G.CONTENT_MODIFIED.modified=true;G.CONTENT_MODIFIED.message="sms_to_save_draft";G.CONTENT_MODIFIED.callback.ok=F;G.CONTENT_MODIFIED.callback.no=B.noop;G.CONTENT_MODIFIED.data={content:B("#chat-input","#smsChatRoom").val(),numbers:ab};return}if(Z&&ac){G.CONTENT_MODIFIED.modified=true;G.CONTENT_MODIFIED.message="sms_no_recipient";G.CONTENT_MODIFIED.callback.ok=B.noop;G.CONTENT_MODIFIED.callback.no=function(){return true};return}}else{G.resetContentModifyValue()}}function F(aa){var ac=new Date();var ab={index:-1,currentTimeString:getCurrentTimeString(ac),groupId:aa.numbers.length>1?ac.getTime():"",message:aa.content,numbers:aa.numbers};!aa.noLoading&&showLoading("waiting");d.saveSMS(ab,function(){if(aa.isFromBack){Z(aa.numbers);!aa.noLoading&&successOverlay("sms_save_draft_success")}else{!aa.noLoading&&successOverlay("sms_save_draft_success")}},function(){!aa.noLoading&&errorOverlay("sms_save_draft_failed")});function Z(ad){d.getSMSMessages({page:0,smsCount:5,nMessageStoreType:1,tags:4,orderBy:"order by id desc"},function(aj){if(aj.messages&&aj.messages.length>0){var ai="",ak="",ae="",al=0,ag=[];for(;al<aj.messages.length;al++){var af=aj.messages[al];for(var ah=0;ah<ad.length;ah++){var am=ad[ah];if(getLastNumber(am,G.SMS_MATCH_LENGTH)==getLastNumber(af.number,G.SMS_MATCH_LENGTH)){af.number=am}}if(ai!=""&&ai!=af.groupId){break}S(af);if(af.groupId==""){break}else{ai=af.groupId;var ao=getShowNameByNumber(af.number);ak+=(al==0?"":";")+ao;ae+=(al==0?"":";")+ao}ag.push(af)}if(ai==""){var af=aj.messages[0];af.hasDraft=true;e(af)}else{var af=aj.messages[0];var an=10;if(getEncodeType(ak).encodeType=="UNICODE"){an=10}af.draftShowNameTitle=ae;af.draftShowName=ak.length>an?ak.substring(0,an)+"...":ak;af.hasDraft=true;af.totalCount=al;i[ai]=ag;e(af)}tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length)}},function(){})}}draftSmsItemClickHandler=function(ab){if(O){return false}O=true;var ad=i[ab];var Z=[];var ac=[];for(var aa=0;ad&&aa<ad.length;aa++){Z.push(getLastNumber(ad[aa].number,G.SMS_MATCH_LENGTH));ac.push(ad[aa].id+"")}B("#chosenUser","#smsChatRoom").show();B("#chosenUser1","#smsChatRoom").addClass("hide").html("");B("select.chosen-select-deselect").val(Z).trigger("chosen:updated.chosen");B("#chat-input","#smsChatRoom").val(ad[0].content);updateChatInputWordLength();clearChatList();C("chat");N();gotoBottom();O=false;J(ac,ab)};deletePhoneMessageClickHandler=function(Z){showConfirm("confirm_sms_delete",function(){showLoading("deleting");var aa=[];B.each(G.dbMsgs,function(ab,ac){if(ac.number==Z){aa.push(ac.id)}});d.deleteMessage({ids:aa},function(ab){B("#smslist-item-"+getLastNumber(Z,G.SMS_MATCH_LENGTH)).hide().remove();synchSmsList([Z],aa);successOverlay();tryToDisableCheckAll(B("#smslist-checkAll","#smsListForm"),B(".smslist-item","#smslist-table").length)},function(ab){errorOverlay(ab.errorText)})})};synchSmsList=function(ab,Z){if(ab&&ab.length>0){G.listMsgs=B.grep(G.listMsgs,function(ad,ac){return B.inArray(ad.number,ab)==-1})}if(Z&&Z.length>0){var aa=[];B.each(G.dbMsgs,function(ac,ad){if(B.inArray(ad.id,Z)==-1){aa.push(ad)}});G.dbMsgs=aa}};function a(){var aa=B(".smslist-item");var Z;if(aa.length>0){Z=aa[aa.length-1]}else{Z=aa[0]}L=Z?Z.offsetTop:600}function l(){if(f&&!W&&L<(B(window).scrollTop()+B(window).height())&&B(".smslist-item").length!=G.listMsgs.length){W=true;addTimeout(function(){removeChecked("smslist-checkAll");h();a();W=false},100)}}function z(){disableBtn(B("#btn-back"));B("a","#left").bind("click",function(){return false});B("a","#list-nav").bind("click",function(){return false})}function U(){enableBtn(B("#btn-back"));B("a","#left").unbind("click");B("a","#list-nav").unbind("click")}clearSearchKey=function(){updateSearchValue(B.i18n.prop("search"));B("#searchInput").addClass("ko-grid-search-txt-default").attr("data-trans","search")};searchTextClick=function(){var Z=B("#searchInput");if(Z.hasClass("ko-grid-search-txt-default")){updateSearchValue("");Z.val("");Z.removeClass("ko-grid-search-txt-default").removeAttr("data-trans")}};searchTextBlur=function(){var Z=B.trim(B("#searchInput").val()).toLowerCase();if(Z==""){clearSearchKey()}};updateSearchValue=function(Z){if(Z==""||Z==B.i18n.prop("search")){return true}w(Z)};function w(ab){ab=B.trim(ab);var aa=B("tr","#smslist-table"),ae=aa.length;if(ab==""){aa.show();return false}aa.hide();while(ae){var ac=B(aa[ae-1]),ad=B("td",ac),Z=ad.length;while(Z-1){var af=B(ad[Z-1]);if(af.text().toLowerCase().indexOf(ab.toLowerCase())!=-1){ac.show();break}Z--}ae--}addTimeout(function(){B(":checkbox:checked","#addPhonebookContainer").removeAttr("checked");vm.selectedItemIds([]);vm.freshStatus(B.now());renderCheckbox()},300);return true}window.smsUtil={changeLocationHandler:function(Z){if(B(Z).val()=="sim"){window.location.hash="#sim_messages"}else{window.location.hash="#sms"}}};return{init:P}});