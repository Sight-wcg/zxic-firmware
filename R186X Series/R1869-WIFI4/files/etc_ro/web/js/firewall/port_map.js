define(["jquery","knockout","config/config","service","underscore"],function(d,j,b,e,h){var g=h.map(b.MAP_PROTOCOL_MODES,function(k){return new Option(k.name,k.value)});var c=[{columnType:"checkbox",rowText:"index",width:"8%"},{headerTextTrans:"source_port",rowText:"sourcePort",width:"20%"},{headerTextTrans:"dest_ip_address",rowText:"destIpAddress",width:"20%"},{headerTextTrans:"dest_port",rowText:"destPort",width:"20%"},{headerTextTrans:"protocol",rowText:"protocol",width:"12%"},{headerTextTrans:"comment",rowText:"comment",width:"20%"}];function a(){var l=this;var m=f();l.portMapEnable=j.observable(m.portMapEnable);l.oriPortMapEnable=j.observable(m.portMapEnable);l.sourcePort=j.observable("");l.destIpAddress=j.observable("");l.destPort=j.observable("");l.modes=j.observableArray(g);l.selectedMode=j.observable("TCP&UDP");l.comment=j.observable("");l.rules=j.observableArray(m.portMapRules);l.gridTemplate=new j.simpleGrid.viewModel({data:l.rules(),idName:"index",columns:c,tmplType:"list",pageSize:10});l.callback=function(n){if(n.result=="success"){k();i(l);successOverlay()}else{errorOverlay()}};function k(){l.sourcePort("");l.destIpAddress("");l.destPort("");l.selectedMode("TCP&UDP");l.comment("")}l.enablePortMap=function(){showLoading();var n={};n.portMapEnable=l.portMapEnable();e.enablePortMap(n,l.callback)};l.save=function(){if(l.rules().length>=b.portForwardMax){showAlert({msg:"rules_max",params:b.portForwardMax});return}if(l.checkExist()){showAlert("rule_exist");return}showLoading();var n={};n.portMapEnable=l.portMapEnable();n.sourcePort=l.sourcePort();n.destIpAddress=l.destIpAddress();n.destPort=l.destPort();n.protocol=l.selectedMode();n.comment=l.comment();e.setPortMap(n,l.callback)};l.checkExist=function(){var o={sourcePort:l.sourcePort(),destIpAddress:l.destIpAddress(),destPort:l.destPort(),protocol:transProtocolValue(l.selectedMode())};var q;var p=l.rules();for(var n=0;n<p.length;n++){q={sourcePort:p[n].sourcePort,destIpAddress:p[n].destIpAddress,destPort:p[n].destPort,protocol:p[n].protocol};if(h.isEqual(o,q)){return true}}return false};l.deleteMapRules=function(){var n=l.gridTemplate.selectedIds();if(n.length==0){showAlert("no_data_selected");return}showConfirm("confirm_data_delete",function(){showLoading();var o={};o.indexs=n;e.deleteMapRules(o,l.callback)})}}function f(){return e.getPortMap()}function i(l){var m;if(l){m=l;var n=f();m.portMapEnable(n.portMapEnable);m.oriPortMapEnable(n.portMapEnable);m.rules(n.portMapRules);m.gridTemplate.clearAllChecked();m.gridTemplate.data(n.portMapRules);refreshTableHeight();renderCheckbox();return}m=new a();var k=d("#container");j.cleanNode(k[0]);j.applyBindings(m,k[0]);fixTableHeight();d("#mapBasicForm").validate({submitHandler:function(){m.enablePortMap()}});d("#portMapListForm").validate({submitHandler:function(){m.deleteMapRules()}});d("#portMapForm").validate({submitHandler:function(){m.save()},rules:{txtDestIpAddress:{ip_check:true},txtSourcePort:{digits:true,range_except:[1,65000]},txtDestPort:{digits:true,range_except:[1,65000]},txtComment:{comment_check:true}},errorPlacement:function(o,p){if(p.attr("name")=="txtDestIpAddress"){o.appendTo("#txtDestIpAddressErrorDiv")}else{if(p.attr("name")=="txtSourcePort"){o.appendTo("#txtSourcePortErrorDiv")}else{if(p.attr("name")=="txtDestPort"){o.appendTo("#txtDestPortErrorDiv")}else{o.insertAfter(p)}}}}})}return{init:i}});