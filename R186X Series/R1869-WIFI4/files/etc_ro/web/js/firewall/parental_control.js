define(["jquery","knockout","config/config","service","underscore"],function(g,c,p,s,r){var b={MAIN:0,MANAGE:1,RULE:2};var k=10;var m=null;function o(){var t=this;var x=s.getHostNameList({}).devices;t.currentPage=c.observable(b.MAIN);t.pages=b;t.currentUserInChildGroup=c.observable(true);t.childGroupList=c.observable([]);t.childGroupMac=c.computed(function(){return r.map(t.childGroupList(),function(y){return y.mac})});t.fetchChildGroupList=function(y){s.childGroupList({},function(z){t.currentUserInChildGroup(s.checkCurrentUserInChildGroup(z.devices).result);t.childGroupList([]);r.map(z.devices,function(B,A){B.idx=A;B.hostname=e.getHostName(B.hostname,B.mac,x)});t.childGroupList(z.devices);if(r.isFunction(y)){y.apply(this)}})};t.fetchChildGroupList();t.attachedDevices=c.observable([]);t.manageHandler=function(){t.currentPage(b.MANAGE);t.fetchAttachedDevices()};t.fetchAttachedDevices=function(y){t.attachedDevices([]);var A=[];var z=0;s.getCurrentlyAttachedDevicesInfo({},function(C){z++;var B=r.map(C.attachedDevices,function(D){D.idx=r.uniqueId("wireless_");D.hostName=e.getHostName(D.hostName,D.macAddress,x);D.inChildGroup=r.contains(t.childGroupMac(),D.macAddress);return D});if(z==1){A=B}else{t.attachedDevices(r.flatten([A,B]));if(r.isFunction(y)){y.apply(this)}}});s.getAttachedCableDevices({},function(C){z++;var B=r.map(C.attachedDevices,function(D){D.idx=r.uniqueId("wireless_");D.hostName=e.getHostName(D.hostName,D.macAddress,x);D.inChildGroup=r.contains(t.childGroupMac(),D.macAddress);return D});if(z==1){A=B}else{t.attachedDevices(r.flatten([A,B]));if(r.isFunction(y)){y.apply(this)}}})};c.computed(function(){t.attachedDevices();t.childGroupList();g("#pc_children_group_form").translate()}).extend({notify:"always",throttle:300});t.backToMainHandler=function(){t.currentPage(b.MAIN)};function u(y,z){showLoading();s.addChildGroup(z,function(A){t.fetchChildGroupList(function(){t.fetchAttachedDevices(function(){hideLoading();if(y){s.logout({},function(){window.location="index.html"})}})})},function(A){errorOverlay()})}t.addChildGroupHandler=function(z){var y=s.getCurretnMAC();if(y==z.macAddress){showConfirm("parental_add_self",function(){u(true,z)})}else{u(false,z)}};t.removeChildGroupHandler=function(y){showLoading();s.removeChildGroup(y,function(z){t.fetchChildGroupList(function(){t.fetchAttachedDevices(function(){hideLoading()})})},function(z){errorOverlay()})};t.dealElement=function(z,y){if(z){g("#edit_btn_"+y+",#hostname_txt_"+y).hide();g("#save_btn_"+y+",#cancel_btn_"+y+",#hostname_input_"+y).show()}else{g("#edit_btn_"+y+",#hostname_txt_"+y).show();g("#save_btn_"+y+",#cancel_btn_"+y+",#hostname_input_"+y).hide()}};t.editHostNameHandler=function(y){g("#hostname_input_"+y.idx).val(y.hostname);t.dealElement(true,y.idx);return false};t.saveHostNameHandler=function(A){var B=g("#hostname_input_"+A.idx);var z=g.trim(B.val());if(z==""){g(".promptErrorLabel","#confirm-message-container").text(g.i18n.prop("required"));var y=B.closest("td").addClass("has-error");addTimeout(function(){y.removeClass("has-error")},5000);showAlert("required");return false}else{if(z.indexOf(" ")==0||z.lastIndexOf(" ")==(z.length-1)||/[\*\+\$\[&:,;<>'"\\`\]ï¿¥]{1,32}/.test(z)){showAlert("modify_hostname_invalid");return false}}showLoading();A.hostname=z;s.editHostName(A,function(){s.getHostNameList({},function(C){x=C.devices;t.fetchChildGroupList(function(){hideLoading()});t.fetchAttachedDevices()})},function(){errorOverlay()})};t.cancelEditHostNameHandler=function(y){t.dealElement(false,y.idx)};t.siteList=c.observable([]);t.selectedIds=c.observableArray([]);t.disableAdd=c.computed(function(){return t.siteList().length==k});t.fetchSiteWhiteList=function(y){s.getSiteWhiteList({},function(z){t.selectedIds([]);t.siteList(z.siteList);r.isFunction(y)&&y.apply(this)},function(){t.siteList([]);r.isFunction(y)&&y.apply(this)})};c.computed(function(){t.siteList();t.selectedIds();setTimeout(function(){renderCheckbox()},100);g("#pc_site_white_list_form").translate()});t.checkboxClickHandler=function(z,y){addTimeout(function(){t.selectedIds(d())},100)};t.openAddSitePopoverHandler=function(){var y=g("#addNewSiteTmpl").html();popover.open({target:g("#openAddSiteBtn"),html:y,width:"300px",validation:i})};t.removeWhiteSite=function(z,y){v([z.id])};t.removeSelectedWhiteSite=function(){v(d())};t.removeAllWhiteSite=function(){v(n())};function v(y){showConfirm("confirm_data_delete",function(){showLoading();s.removeSiteWhite({ids:y},function(z){t.fetchSiteWhiteList(function(){successOverlay()})},function(z){t.fetchSiteWhiteList(function(){errorOverlay()})})})}t.saveSiteWhite=function(A,z){popover.hide();var y=r.find(t.siteList(),function(B){return B.site==z});if(y){showAlert("pc_link_exist",function(){setTimeout(function(){popover.show()},200)});return false}showLoading();s.saveSiteWhite({name:A,site:z},function(){t.fetchSiteWhiteList(function(){popover.close();successOverlay()})},function(){t.fetchSiteWhiteList(function(){errorOverlay();popover.show()})})};t.notSave=c.observable(false);t.fetchTimeLimited=function(){s.getTimeLimited({},function(A){for(var y in A){for(var z=0;z<A[y].length;z++){var B="td_"+y+"_"+A[y][z];g("#"+B).addClass("active")}}},function(){})};t.saveTimeLimitedHandler=function(){showLoading();var y=a();var z=f(y);s.saveTimeLimited({time:z},function(){t.notSave(false);successOverlay()},function(){errorOverlay()})};t.bindEvent=function(){g("td:not('.col-head')","#pc_time_limited_tbody").addClass("cursorhand").die().click(function(){t.notSave(true);g(this).toggleClass("active")}).hover(function(){var A=g(this);var y=A.data("week");var z=A.data("hour");g("tr:nth-child("+(y+1)+") td:first-child","#pc_time_limited_tbody").addClass("time_td_hover");g("#col_"+z).addClass("time_td_hover");if(A.not(".active")){A.addClass("time_td_hover")}},function(){var A=g(this);var y=A.data("week");var z=A.data("hour");g("tr:nth-child("+(y+1)+") td:first-child","#pc_time_limited_tbody").removeClass("time_td_hover");g("#col_"+z).removeClass("time_td_hover");A.removeClass("time_td_hover")})};var w=false;t.openRulePage=function(){if(t.currentPage()==b.RULE){return}t.currentPage(b.RULE);t.currentUserInChildGroup(s.checkCurrentUserInChildGroup().result);q();if(!w){if(!t.currentUserInChildGroup()){t.bindEvent()}w=true}showLoading();t.fetchTimeLimited();t.fetchSiteWhiteList(function(){hideLoading()})}}var e={getHostName:function(w,v,u){var t=r.find(u,function(x){return x.mac==v});return t?t.hostname:w}};function d(){return l(true)}function n(){return l(false)}function l(u){var t=[];g(":checkbox"+(u?":checked":""),"#pb_white_list").each(function(v,w){t.push(w.value)});return t}function i(){g("#whiteSiteAddForm").validate({submitHandler:function(){var u=g("#siteName").val();var t=g("#siteLink").val();m.saveSiteWhite(u,t)},rules:{siteName:"siteName_check",siteLink:"siteLink_check"}})}function a(){var t={"0":[],"1":[],"2":[],"3":[],"4":[],"5":[],"6":[]};g("td.active","#pc_time_limited_tbody").each(function(v,z){var y=g(z);var u=y.data("week");var x=y.data("hour");t[u].push(x)});return t}function f(w){var t="";for(var v in w){var u=r.sortBy(w[v],function(x){return x});if(w[v].length){t+=v+"+";t+=u.join(",");t+=";"}}return t.substring(0,t.length-1)}function q(){g("tr","#pc_time_limited_tbody").each(function(t,v){var u=g(v);g("td:not(:first)",u).each(function(x,w){var z=g(w);var y=h(x);z.attr({id:"td_"+t+"_"+y}).data({week:t,hour:y})})});g("td.active","#pc_time_limited_tbody").removeClass("active");g("thead td:not(:first)","#pc_time_limited_form").each(function(t,v){var u=h(t);g(v).attr({id:"col_"+u})});m.notSave(false)}function h(t){if(t>16){return t-17}else{return t+7}}function j(){var t=g("#container");c.cleanNode(t[0]);m=new o();c.applyBindings(m,t[0])}return{init:j}});