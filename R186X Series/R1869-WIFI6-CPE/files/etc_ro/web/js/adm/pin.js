define(["jquery","knockout","config/config","service"],function(g,d,c,a){var e={common:0,requirePin:1,modifyPin:2,requirePuk:3,destroyed:4};var f={enable:"1",disable:"0"};function b(){var i=this;var j=a.getPinData();i.isDataCard=c.PRODUCT_TYPE=="DATACARD";i.originPinStatus=d.observable(j.pin_status);i.pinStatus=d.observable(j.pin_status);i.pinNumber=d.observable(j.pinnumber);i.pukNumber=d.observable(j.puknumber);i.currentPin=d.observable();i.newPin=d.observable();i.confirmPin=d.observable();i.puk=d.observable();i.pageState=d.observable();i.optSuccess=true;i.changePin=function(){if(i.isConnectedNetWork()){showAlert("cannot_operate_when_connected");return}if(i.pageState()==e.common){return}var k={oldPin:i.currentPin(),newPin:i.newPin()};showLoading();if(i.pageState()==e.modifyPin){a.changePin(k,i.callback)}else{if(i.pageState()==e.requirePuk){k={PinNumber:i.newPin(),PUKNumber:i.puk()};a.enterPUK(k,i.callback)}else{if(i.pinStatus()==f.enable){a.enablePin(k,i.callback)}else{a.disablePin(k,i.callback)}}}};i.callback=function(k){if(k&&k.result==true){i.optSuccess=true;successOverlay()}else{i.optSuccess=false;if(i.pinNumber()==2){showAlert("last_enter_pin")}else{if(i.pukNumber()==2){showAlert("last_enter_puk")}else{errorOverlay()}}}h(i)};i.displayModifyPinPage=function(){if(i.isConnectedNetWork()){showAlert("cannot_operate_when_connected");return}i.pinStatus(i.originPinStatus());i.pageState(e.modifyPin);i.clear()};i.cancel=function(){i.pageState(e.common);i.pinStatus(i.originPinStatus());i.clear()};i.clear=function(){i.currentPin("");i.newPin("");i.confirmPin("");i.puk("");clearValidateMsg()};i.pinStatusChangeEvent=d.dependentObservable(function(){if(i.pinStatus()==i.originPinStatus()){i.pageState(e.common)}else{i.pageState(e.requirePin)}i.clear()},this);i.computePageState=function(k){if(k.pinnumber>0){if(i.optSuccess){i.cancel()}else{i.clear()}}else{i.clear();if(k.puknumber>0){i.pageState(e.requirePuk)}else{i.pageState(e.destroyed)}}};i.computePageState(j);i.isConnectedNetWork=function(){var k=a.getConnectionInfo();return k.connectStatus=="ppp_connected"};i.fixPageEnable=function(){if(i.isConnectedNetWork()){g("#frmPin :input").each(function(){disableBtn(g(this))});clearValidateMsg()}else{g("#frmPin :input").each(function(){if(this.id=="txtPin"||this.id=="btnPinApply"){if(i.pageState()==e.common){disableBtn(g(this));return}}if(this.id=="btnModifyPin"){if(i.originPinStatus()!=f.enable){disableBtn(g(this));return}}if(this.id=="pinEnable"||this.id=="pinDisable"){if(i.pageState()==e.modifyPin){disableBtn(g(this));return}}enableBtn(g(this))})}}}function h(j){var k=j;if(k){var l=a.getPinData();k.originPinStatus(l.pin_status);k.pinNumber(l.pinnumber);k.pukNumber(l.puknumber);k.computePageState(l)}else{k=new b();addInterval(function(){k.fixPageEnable()},1000)}var i=g("#container")[0];d.cleanNode(i);d.applyBindings(k,i);k.fixPageEnable();g("#frmPin").validate({submitHandler:function(){k.changePin()},rules:{txtPuk:"puk_check",txtPin:"pin_check",txtNewPin:"pin_check",txtConfirmPin:{equalToPin:"#txtNewPin"}}})}return{init:h}});