define(["jquery","knockout","config/config","service","underscore"],function(d,a,n,r,p){var l=p.map(n.pppoeModes,function(s){return new Option(s.name,s.value)});var f=p.map(n.dialActions,function(s){return new Option(s.name,s.value)});var o=0;var i=0;var h=false;function b(){var y=r.getPppoeParams();var z=y;var A=this;A.modes=a.observableArray(l);A.isPppoeMode=a.observable(false);A.isStaticMode=a.observable(false);A.isAutoMode=a.observable(false);A.action=a.observable();A.btnTrans=a.observable();A.enableFlag=a.observable();A.isShowDisbtn=a.observable();A.isShowCancelbtn=a.observable();A.staticNoticeShow=a.observable();A.dhcpNoticeShow=a.observable();A.pppoeNoticeShow=a.observable();A.autoNoticeShow=a.observable();A.staticNotice=a.observable();A.dhcpNotice=a.observable();A.pppoeNotice=a.observable();A.autoNotice=a.observable();A.dhcpNoticeText=a.observable();A.staticNoticeText=a.observable();A.pppoeNoticeText=a.observable();A.autoNoticeText=a.observable();A.currentMode=a.observable(y.ethwan_mode);if(y.rj45_state=="working"){s()}else{if(y.rj45_state=="connect"){h=true;v("connect")}else{if(y.rj45_state=="dead"){w()}}}A.user=a.observable(y.pppoe_username);A.password=a.observable(y.pppoe_password);A.autoUser=a.observable(y.pppoe_username);A.autoPassword=a.observable(y.pppoe_password);A.pppMode=a.observable(y.ethwan_dialmode);x();A.radioHandler=function(){x();return true};A.changeModeDiv=function(){x()};A.ipAddress=a.observable(y.static_wan_ipaddr);A.subnetMask=a.observable(y.static_wan_netmask);A.defaultGateway=a.observable(y.static_wan_gateway);A.primaryDNS=a.observable(y.static_wan_primary_dns);A.secondaryDNS=a.observable(y.static_wan_secondary_dns);addInterval(function(){z=r.getPppoeParams();y.rj45_state=z.rj45_state;x()},1000);A.save=function(){A.dhcpNoticeShow(false);A.staticNoticeShow(false);A.pppoeNoticeShow(false);A.autoNoticeShow(false);if(y.rj45_state=="dead"){showAlert("pppoe_msg");return}var B={};if(d("#pppoe_mode").val()=="PPPOE"){B=d.extend({},{goformId:"WAN_GATEWAYMODE_PPPOE",pppoe_username:A.user(),pppoe_password:A.password()})}else{if(d("#pppoe_mode").val()=="STATIC"){if(A.ipAddress()==A.defaultGateway()){showAlert("ip_gate_not_same");return}if(m(A.ipAddress(),y.lan_ipaddr,y.lan_netmask)){showAlert("ip_innergate_not_same");return}B=d.extend({},{goformId:"WAN_GATEWAYMODE_STATIC",static_wan_ipaddr:A.ipAddress(),static_wan_netmask:A.subnetMask(),static_wan_gateway:A.defaultGateway(),static_wan_primary_dns:A.primaryDNS(),static_wan_secondary_dns:A.secondaryDNS(),WAN_MODE:"STATIC"})}else{if(d("#pppoe_mode").val()=="AUTO"){B=d.extend({},{goformId:"WAN_GATEWAYMODE_AUTO",pppoe_username:A.autoUser(),pppoe_password:A.autoPassword()})}else{B=d.extend({},{goformId:"WAN_GATEWAYMODE_DHCP"})}}}B.action_link="connect";B.dial_mode=A.pppMode();showLoading("waiting");r.setPppoeDialMode(B,function(C){if(C.result){A.currentMode(d("#pppoe_mode").val());y=r.getPppoeParams();i=0;h=false;v("connect");d("#pppoeApply").translate()}else{errorOverlay("pppoe_message_send_fail")}})};A.cancelConnect=function(){A.dhcpNoticeShow(false);A.staticNoticeShow(false);A.pppoeNoticeShow(false);A.autoNoticeShow(false);if(y.rj45_state=="dead"){showAlert("pppoe_msg");return}var B={dial_mode:A.pppMode(),action_link:"disconnect"};if(y.ethwan_mode=="PPPOE"){B=d.extend(B,{goformId:"WAN_GATEWAYMODE_PPPOE",pppoe_username:y.pppoe_username,pppoe_password:y.pppoe_password})}else{if(y.ethwan_mode=="STATIC"){B=d.extend(B,{goformId:"WAN_GATEWAYMODE_STATIC",static_wan_ipaddr:y.static_wan_ipaddr,static_wan_netmask:y.static_wan_netmask,static_wan_gateway:y.static_wan_gateway,static_wan_primary_dns:y.static_wan_primary_dns,static_wan_secondary_dns:y.static_wan_secondary_dns,WAN_MODE:"STATIC"})}else{if(y.ethwan_mode=="AUTO"){B=d.extend(B,{goformId:"WAN_GATEWAYMODE_AUTO",pppoe_username:y.pppoe_username,pppoe_password:y.pppoe_password})}else{B=d.extend(B,{goformId:"WAN_GATEWAYMODE_DHCP"})}}}showLoading("waiting");r.setPppoeDialMode(B,function(C){if(C.result){i=0;h=false;v("disconnect");d("#pppoeApply").translate()}else{errorOverlay("pppoe_message_send_fail")}})};function x(){w();if(A.currentMode()=="PPPOE"){A.isPppoeMode(true);A.isStaticMode(false);A.isAutoMode(false);A.staticNoticeShow(false);A.dhcpNoticeShow(false);A.autoNoticeShow(false)}else{if(A.currentMode()=="STATIC"){A.isStaticMode(true);A.isPppoeMode(false);A.isAutoMode(false);A.dhcpNoticeShow(false);A.pppoeNoticeShow(false);A.autoNoticeShow(false)}else{if(A.currentMode()=="AUTO"){A.isStaticMode(false);A.isPppoeMode(false);A.isAutoMode(true);A.dhcpNoticeShow(false);A.pppoeNoticeShow(false);A.staticNoticeShow(false)}else{A.isStaticMode(false);A.isPppoeMode(false);A.isAutoMode(false);A.staticNoticeShow(false);A.pppoeNoticeShow(false);A.autoNoticeShow(false)}}}if((y.rj45_state=="working"||y.rj45_state=="connect")&&z.ethwan_dialmode!="auto_dial"){A.enableFlag(false)}else{A.enableFlag(true)}if(y.rj45_state=="working"){A.action("disconnect")}else{if(y.rj45_state=="connect"){if(A.pppMode()=="auto_dial"){A.action("connect")}else{A.action("disconnect")}}else{A.action("connect")}}if(A.pppMode()!="auto_dial"&&A.currentMode()==z.ethwan_mode){A.btnTrans("connect")}else{A.btnTrans("apply")}if(y.rj45_state=="idle"){d("#pppoeApply").attr("disabled",false)}else{d("#pppoeApply").attr("disabled",true)}A.isShowDisbtn(A.pppMode()!="auto_dial"&&y.rj45_state=="working");A.isShowCancelbtn(A.pppMode()!="auto_dial"&&y.rj45_state=="connect");d("#pppoeApply").translate()}function v(B){o&&window.clearInterval(o);if("connect"==B){if(A.currentMode()=="DHCP"){A.dhcpNoticeShow(true);A.dhcpNotice("dyn_processing");A.dhcpNoticeText(d.i18n.prop("dyn_processing"))}else{if(A.currentMode()=="STATIC"){A.staticNoticeShow(true);A.staticNotice("static_processing");A.staticNoticeText(d.i18n.prop("static_processing"))}else{if(A.currentMode()=="PPPOE"){A.pppoeNoticeShow(true);A.pppoeNotice("pppoe_processing");A.pppoeNoticeText(d.i18n.prop("pppoe_processing"))}else{A.autoNoticeShow(true);A.autoNotice("auto_processing");A.autoNoticeText(d.i18n.prop("auto_processing"))}}}o=addInterval(function(){u()},2000)}else{o=addInterval(function(){t()},2000)}}function u(){if(i<1){i++;return}if(y.rj45_state=="connect"){if(A.currentMode()==z.ethwan_mode){if(A.currentMode()=="DHCP"){A.dhcpNoticeShow(true)}else{if(A.currentMode()=="STATIC"){A.staticNoticeShow(true)}else{if(A.currentMode()=="PPPOE"){A.pppoeNoticeShow(true)}else{if(A.currentMode()=="AUTO"){A.autoNoticeShow(true)}}}}}if(i>6){if(h==false){h=true;showAlert("ussd_operation_timeout")}}i++}else{if(y.rj45_state=="idle"){hideLoading();if(A.currentMode()=="DHCP"&&z.ethwan_mode=="DHCP"){h==false&&A.dhcpNoticeShow(true);A.dhcpNotice("dyn_fail");A.dhcpNoticeText(d.i18n.prop("dyn_fail"))}if(A.currentMode()=="STATIC"&&z.ethwan_mode=="STATIC"){h==false&&A.staticNoticeShow(true);A.staticNotice("static_fail");A.staticNoticeText(d.i18n.prop("static_fail"))}if(A.currentMode()=="PPPOE"&&z.ethwan_mode=="PPPOE"){h==false&&A.pppoeNoticeShow(true);A.pppoeNotice("pppoe_fail");A.pppoeNoticeText(d.i18n.prop("pppoe_fail"))}if(A.currentMode()=="AUTO"&&z.ethwan_mode=="AUTO"){h==false&&A.autoNoticeShow(true);A.autoNotice("auto_fail");A.autoNoticeText(d.i18n.prop("auto_fail"))}window.clearInterval(o)}else{if(y.rj45_state=="dead"){hideLoading();w();window.clearInterval(o)}else{if(y.rj45_state=="working"){hideLoading();s();window.clearInterval(o)}else{hideLoading();window.clearInterval(o)}}}}}function t(){if(i<1){i++}else{if(y.rj45_state!="working"&&y.rj45_state!="connect"){A.dhcpNoticeShow(false);A.staticNoticeShow(false);A.pppoeNoticeShow(false);A.autoNoticeShow(false);window.clearInterval(o);successOverlay()}else{if(i>6){if(h==false){h=true;showAlert("ussd_operation_timeout")}window.clearInterval(o)}else{if(i<7){i++}else{hideLoading();window.clearInterval(o)}}}}}function w(){if(y.rj45_state=="dead"){A.dhcpNotice("pppoe_msg");A.dhcpNoticeText(d.i18n.prop("pppoe_msg"));A.staticNotice("pppoe_msg");A.staticNoticeText(d.i18n.prop("pppoe_msg"));A.pppoeNotice("pppoe_msg");A.pppoeNoticeText(d.i18n.prop("pppoe_msg"));A.autoNotice("pppoe_msg");A.autoNoticeText(d.i18n.prop("pppoe_msg"));if(A.currentMode()=="DHCP"){A.dhcpNoticeShow(true)}else{if(A.currentMode()=="STATIC"){A.staticNoticeShow(true)}else{if(A.currentMode()=="PPPOE"){A.pppoeNoticeShow(true)}else{if(A.currentMode()=="AUTO"){A.autoNoticeShow(true)}}}}}else{if(A.currentMode()=="DHCP"&&A.dhcpNotice()=="pppoe_msg"){A.dhcpNoticeShow(false)}else{if(A.currentMode()=="STATIC"&&A.staticNotice()=="pppoe_msg"){A.staticNoticeShow(false)}else{if(A.currentMode()=="PPPOE"&&A.pppoeNotice()=="pppoe_msg"){A.pppoeNoticeShow(false)}else{if(A.currentMode()=="AUTO"&&A.autoNotice()=="pppoe_msg"){A.autoNoticeShow(false)}}}}}}function s(){if(A.currentMode()==z.ethwan_mode){if(A.currentMode()=="DHCP"){A.dhcpNoticeShow(true);A.dhcpNotice("dyn_success");A.dhcpNoticeText(d.i18n.prop("dyn_success"))}else{if(A.currentMode()=="STATIC"){A.staticNoticeShow(true);A.staticNotice("static_success");A.staticNoticeText(d.i18n.prop("static_success"))}else{if(A.currentMode()=="PPPOE"){A.pppoeNoticeShow(true);A.pppoeNotice("pppoe_success");A.pppoeNoticeText(d.i18n.prop("pppoe_success"))}else{if(A.currentMode()=="AUTO"){A.autoNoticeShow(true);A.autoNotice("auto_success");A.autoNoticeText(d.i18n.prop("auto_success"))}}}}}}}function k(){var s=d("#container");a.cleanNode(s[0]);var t=new b();a.applyBindings(t,s[0]);d("#pppoeApply").translate();d("#pppoeForm").validate({submitHandler:function(){t.save()},rules:{txtPin:"wps_pin_check",txtIpAddress:"dmz_ip_check",txtSubnetMask:{ipv4:true,subnetmask_check:true},txtDefaultGateway:{ipv4:true,gateway_check:true},txtPrimaryDNS:{ipv4:true,dns_check:true},txtSecondaryDNS:{ipv4:true,dns_check:true}}})}function m(y,u,t){if(!y||!u||!t){return false}if(y==u){return true}var x=[],w=[],s=[];addr1=y.split(".");addr2=u.split(".");s=t.split(".");for(var v=0;v<addr1.length;v+=1){x.push(parseInt(addr1[v])&parseInt(s[v]));w.push(parseInt(addr2[v])&parseInt(s[v]))}if(x.join(".")==w.join(".")){return true}else{return false}}function j(s){if("0.0.0.0"==s||"255.255.255.255"==s){return false}return true}function c(s){var t=new Array();t=s.split(".");if(t.length!=4){return false}t[0]=parseInt(t[0]);t[1]=parseInt(t[1]);t[2]=parseInt(t[2]);t[3]=parseInt(t[3]);if(t[3]!=0){if(t[2]!=255||t[1]!=255||t[0]!=255){return false}else{if(!q(t[3])){return false}}}if(t[2]!=0){if(t[1]!=255||t[0]!=255){return false}else{if(!q(t[2])){return false}}}if(t[1]!=0){if(t[0]!=255){return false}else{if(!q(t[1])){return false}}}if(t[0]!=255){return false}if("0.0.0.0"==s||"255.255.255.255"==s){return false}return true}function q(s){if(s==255||s==254||s==252||s==248||s==240||s==224||s==192||s==128||s==0){return true}else{return false}}jQuery.validator.addMethod("subnetmask_check",function(u,t,v){var s=c(u);return this.optional(t)||s});jQuery.validator.addMethod("dns_check",function(u,t,v){var s=j(u);return this.optional(t)||s});function g(t,s,u){if(e(t,s)==e(s,u)){return true}else{return false}}function e(v,u){var s=[];var x=v.split(".");var w=u.split(".");for(var t=0;t<x.length;t++){s[t]=(x[t]&w[t])}return s.join(".")}jQuery.validator.addMethod("gateway_check",function(u,t,v){var s=g(d("#txtIpAddress").val(),d("#txtSubnetMask").val(),d("#txtDefaultGateway").val());return this.optional(t)||s});return{init:k}});