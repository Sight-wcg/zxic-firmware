define(["jquery","knockout","service","status/statusBar","echarts"],function(e,n,i,d,b){var j=null;var c={tooltip:{formatter:"{b}"},title:{text:"",x:"center",y:"center",itemGap:0,textStyle:{color:"#FFF",fontFamily:"微软雅黑",fontSize:20,fontWeight:"bolder"},subtextStyle:{color:"#FFF",fontFamily:"微软雅黑",fontSize:16,fontWeight:"bolder"}},animation:false,series:[{name:"流量控制",type:"pie",radius:["0","75"],itemStyle:{normal:{label:{show:false},labelLine:{show:false}}},data:[],selectedOffset:3}],color:["red","red","red","red","red"]};function f(){return i.getTrafficAlertInfo()}var k=null;var g=false;var a=false;function l(){g=false;a=false;var x=this;var q=h.fetchTrafficAlertInfo();x.dataLimitChecked=n.observable(q.dataLimitChecked=="0"?"0":"1");x.dataLimitTypeChecked=n.observable(q.dataLimitTypeChecked=="0"?"0":"1");var u=q.limitDataMonth.split("_");x.limitDataMonth=n.observable(u[0]||0);x.selectedDataUnit=n.observable(u[1]||1);x.alertDataReach=n.observable(q.alertDataReach||0);x.limitTimeMonth=n.observable(q.limitTimeMonth||0);x.alertTimeReach=n.observable(q.alertTimeReach||0);var o=transUnit(x.limitDataMonth()*x.selectedDataUnit()*1024*1024,false);var s=o.substring(o.length-2);x.limitDataMonth(o.substring(0,o.length-2));x.selectedDataUnit(h.getUnitValue(s));x.usedDataText=n.observable(transUnit(parseInt(q.monthlySent,10)+parseInt(q.monthlyReceived,10),false));var t=h.getDataInfo(x.usedDataText());var p=t.data;var r=t.unit;x.dataUsed=n.observable(p);x.selectedDataUsedUnit=n.observable(h.getUnitValue(r));x.usedDataTextDescData=n.observable("");x.usedDataTextDesc=n.computed(function(){if(isNaN(x.dataUsed())){x.usedDataTextDescData("");return e.i18n.prop("traffic_used_text"," ")}x.usedDataTextDescData(x.dataUsed()+h.getUnit(x.selectedDataUsedUnit()));return e.i18n.prop("traffic_used_text",x.dataUsed()+h.getUnit(x.selectedDataUsedUnit()))});x.limitDataMonthDescData=n.observable("");x.limitDataMonthDesc=n.computed(function(){if(isNaN(x.limitDataMonth())){x.limitDataMonthDescData("");return e.i18n.prop("traffic_limit_data_text"," ")}x.limitDataMonthDescData(x.limitDataMonth()+h.getUnit(x.selectedDataUnit()));return e.i18n.prop("traffic_limit_data_text",x.limitDataMonth()+h.getUnit(x.selectedDataUnit()))});x.alertDataReachDescData=n.observable("");x.alertDataReachDesc=n.computed(function(){if(isNaN(x.limitDataMonth()*x.selectedDataUnit()*x.alertDataReach())){x.alertDataReachDescData(x.alertDataReach()+", ");return e.i18n.prop("traffic_alert_reach_text",x.alertDataReach()," ")}var y=transUnit(x.limitDataMonth()*x.selectedDataUnit()*x.alertDataReach()*1048576/100,false);x.alertDataReachDescData(x.alertDataReach()+","+y);return e.i18n.prop("traffic_alert_reach_text",x.alertDataReach(),y)});x.leftDataDescData=n.observable("");x.leftDataDesc=n.computed(function(){var y=(x.limitDataMonth()*x.selectedDataUnit()-x.dataUsed()*x.selectedDataUsedUnit())*1048576;if(y<0){y=0}if(isNaN(y)){x.leftDataDescData("");return e.i18n.prop("traffic_data_left_text"," ")}x.leftDataDescData(transUnit(y,false));return e.i18n.prop("traffic_data_left_text",transUnit(y,false))});x.monthlyConnectedTime=n.observable(transSecond2Time(q.monthlyConnectedTime));var w=h.getTimeInfo(transTimeUnit(q.monthlyConnectedTime));x.usedTime=n.observable(w.data);x.selectedTimeUsedUnit=n.observable(h.getUnitValue(w.unit));x.usedTimeTextDescData=n.observable("");x.usedTimeTextDesc=n.computed(function(){x.usedTimeTextDescData(x.monthlyConnectedTime());return e.i18n.prop("traffic_used_text",x.monthlyConnectedTime())});var v=h.getTimeInfo(transTimeUnit(parseFloat(x.limitTimeMonth())*3600));x.selectedTimeUnit=n.observable(h.getUnitValue(v.unit));x.limitTimeMonth(v.data);x.limitTimeMonthDescData=n.observable("");x.limitTimeMonthDescText=n.observable("traffic_limit_time_h");x.limitTimeMonthDesc=n.computed(function(){if(isNaN(x.limitTimeMonth())){x.limitTimeMonthDescData(" ");x.limitTimeMonthDescText("traffic_limit_time_h");return e.i18n.prop("traffic_limit_time_h"," ")}x.limitTimeMonthDescData(x.limitTimeMonth());if(x.selectedTimeUnit()=="60"){x.limitTimeMonthDescText("traffic_limit_time_m");return e.i18n.prop("traffic_limit_time_m",x.limitTimeMonth())}else{x.limitTimeMonthDescText("traffic_limit_time_h");return e.i18n.prop("traffic_limit_time_h",x.limitTimeMonth())}});x.alertTimeReachDescData=n.observable("");x.alertTimeReachDesc=n.computed(function(){if(isNaN(x.limitTimeMonth()*x.alertTimeReach())){x.alertTimeReachDescData(x.alertTimeReach()+", ");return e.i18n.prop("traffic_alert_reach_text",x.alertTimeReach()," ")}var y=transSecond2Time(x.limitTimeMonth()*x.selectedTimeUnit()*x.alertTimeReach()/100);x.alertTimeReachDescData(x.alertTimeReach()+","+y);return e.i18n.prop("traffic_alert_reach_text",x.alertTimeReach(),y)});x.leftTimeDescData=n.observable("");x.leftTimeDesc=n.computed(function(){var y=x.limitTimeMonth()*x.selectedTimeUnit()-h.getSecondsFromTime(x.monthlyConnectedTime());if(y<0){y=0}if(isNaN(y)){x.leftTimeDescData(" ");return e.i18n.prop("traffic_data_left_text"," ")}x.leftTimeDescData(transSecond2Time(y));return e.i18n.prop("traffic_data_left_text",transSecond2Time(y))});x.save=function(){if(h.checkFormEditValid(x)&&x.dataLimitChecked()=="1"){return false}if(x.dataLimitChecked()=="1"&&x.dataLimitTypeChecked()=="1"&&x.selectedDataUnit()=="1"&&x.selectedDataUsedUnit()=="1048576"&&!(parseInt(x.dataUsed(),10)<parseInt("4096",10))){showAlert("traffic_over_note");return false}showLoading();i.setTrafficAlertInfo({dataLimitChecked:x.dataLimitChecked(),dataLimitTypeChecked:x.dataLimitTypeChecked(),limitDataMonth:x.limitDataMonth()+"_"+x.selectedDataUnit(),alertDataReach:parseInt(x.alertDataReach(),10),limitTimeMonth:x.selectedTimeUnit()=="60"?x.limitTimeMonth()/60:x.limitTimeMonth(),alertTimeReach:parseInt(x.alertTimeReach(),10)},function(y){if(y.result=="success"){if(x.dataLimitTypeChecked()=="1"&&g){x.saveUsedData()}else{if(x.dataLimitTypeChecked()=="0"&&a){x.saveUsedTime()}else{h.fetchTrafficAlertInfo();h.updateEcharts(x);d.setTrafficAlertPopuped(false);successOverlay()}}}else{errorOverlay()}},function(){h.updateEcharts(x);errorOverlay()})};x.viewEditUsedData=n.observable(false);x.editUsedDataHandler=function(){h.getEle("editUsedData").data("oldValue",x.dataUsed());h.getEle("selectedDataUsedUnit").data("oldValue",x.selectedDataUsedUnit());x.dataUsed(x.dataUsed());x.viewEditUsedData(true)};x.saveUsedData=function(){var y=x.dataUsed()*x.selectedDataUsedUnit();i.trafficCalibration({way:"data",value:y},function(){h.fetchTrafficAlertInfo();h.updateEcharts(x);successOverlay();x.viewEditUsedData(false);d.setTrafficAlertPopuped(false);g=false},function(){h.fetchTrafficAlertInfo();h.updateEcharts(x);errorOverlay()})};x.editUsedDataSaveHandler=function(){if(h.getEle("dataUsed").valid()){g=true;x.viewEditUsedData(false)}};x.editUsedDataCancelHandler=function(){x.dataUsed(h.getEle("editUsedData").data("oldValue"));x.selectedDataUsedUnit(h.getEle("selectedDataUsedUnit").data("oldValue"));h.getEle("editUsedDataCancel").siblings("label.error").hide();x.viewEditUsedData(false)};x.viewEditTotalData=n.observable(false);x.editTotalDataHandler=function(){h.getEle("editTotalData").data("oldValue",x.limitDataMonth());h.getEle("selectedDataUnit").data("oldValue",x.selectedDataUnit());x.viewEditTotalData(true)};x.editTotalDataSaveHandler=function(){if(h.getEle("limitDataMonth").valid()){x.usedDataText(transUnit(x.limitDataMonth()*x.selectedDataUnit()*1048576,false));x.viewEditTotalData(false)}};x.editTotalDataCancelHandler=function(){x.limitDataMonth(h.getEle("editTotalData").data("oldValue"));x.selectedDataUnit(h.getEle("selectedDataUnit").data("oldValue"));x.viewEditTotalData(false)};x.viewEditAlertData=n.observable(false);x.editAlertDataHandler=function(){h.getEle("editAlertData").data("oldValue",x.alertDataReach());x.viewEditAlertData(true)};x.editAlertDataSaveHandler=function(){if(h.getEle("alertDataReach").valid()){x.viewEditAlertData(false)}};x.editAlertDataCancelHandler=function(){x.alertDataReach(h.getEle("editAlertData").data("oldValue"));x.viewEditAlertData(false)};x.viewEditUsedTime=n.observable(false);x.editUsedTimeHandler=function(){h.getEle("editUsedTime").data("oldValue",x.usedTime());x.viewEditUsedTime(true)};x.saveUsedTime=function(){i.trafficCalibration({way:"time",value:x.selectedTimeUsedUnit()=="60"?parseFloat(x.usedTime())/60:x.usedTime()},function(){h.fetchTrafficAlertInfo();h.updateEcharts(x);successOverlay();x.monthlyConnectedTime(transSecond2Time(parseFloat(x.usedTime())*x.selectedTimeUsedUnit()));x.viewEditUsedTime(false);d.setTrafficAlertPopuped(false);a=false},function(){h.fetchTrafficAlertInfo();h.updateEcharts(x);errorOverlay()})};x.editUsedTimeSaveHandler=function(){if(h.getEle("usedTime").valid()){x.monthlyConnectedTime(transSecond2Time(parseFloat(x.usedTime())*x.selectedTimeUsedUnit()));x.viewEditUsedTime(false);a=true}};x.editUsedTimeCancelHandler=function(){x.usedTime(h.getEle("editUsedTime").data("oldValue"));x.viewEditUsedTime(false)};x.viewEditTotalTime=n.observable(false);x.editTotalTimeHandler=function(){h.getEle("editTotalTime").data("oldValue",x.limitTimeMonth());x.viewEditTotalTime(true)};x.editTotalTimeSaveHandler=function(){if(h.getEle("limitTimeMonth").valid()){x.viewEditTotalTime(false)}};x.editTotalTimeCancelHandler=function(){x.limitTimeMonth(h.getEle("editTotalTime").data("oldValue"));x.viewEditTotalTime(false)};x.viewEditAlertTime=n.observable(false);x.editAlertTimeHandler=function(){h.getEle("editAlertTime").data("oldValue",x.alertTimeReach());x.viewEditAlertTime(true)};x.editAlertTimeSaveHandler=function(){if(h.getEle("alertTimeReach").valid()){x.viewEditAlertTime(false)}};x.editAlertTimeCancelHandler=function(){x.alertTimeReach(h.getEle("editAlertTime").data("oldValue"));x.viewEditAlertTime(false)};h.updateEcharts(x)}var h={cacheEle:{},getEle:function(o){if(this.cacheEle.hasOwnProperty("id")){return this.cacheEle[o]}else{this.cacheEle[o]=e("#"+o);return this.cacheEle[o]}},getUnit:function(o){if(o=="1024"){return"GB"}else{if(o=="1048576"){return"TB"}else{return"MB"}}},getUnitValue:function(o){o=o.toUpperCase();if(o=="GB"){return"1024"}else{if(o=="TB"){return"1048576"}else{if(o=="HOUR"){return"3600"}else{if(o=="MINUTE"){return"60"}else{return"1"}}}}},getDataInfo:function(o){return{data:/\d+(.\d+)?/.exec(o)[0],unit:/[A-Z]{1,2}/.exec(o)[0]}},getTimeInfo:function(o){return{data:/\d+(.\d+)?/.exec(o)[0],unit:/[a-z]{4,6}/.exec(o)[0]}},getTimeHours:function(p){var o=p.split(":");return{h:parseInt(o[0],10),m:parseInt(o[1],10),s:parseInt(o[2],10)}},getSecondsFromTime:function(p){var o=this.getTimeHours(p);return o.h*3600+o.m*60+o.s},fetchTrafficAlertInfo:function(){k=f();return k},checkFormEditValid:function(p){var o=p.dataLimitTypeChecked()=="1"&&(p.viewEditUsedData()||p.viewEditAlertData()||p.viewEditTotalData());var s=p.dataLimitTypeChecked()=="0"&&(p.viewEditUsedTime()||p.viewEditAlertTime()||p.viewEditTotalTime());if(o||s){e(".border-color-transition:visible").addClass("attention-focus");addTimeout(function(){e(".border-color-transition:visible").removeClass("attention-focus")},1500);return true}else{var q=false;if(p.dataLimitTypeChecked()==1){if(p.alertDataReach()=="0"){p.editAlertDataHandler();q=true}if(p.limitDataMonth()=="0"){p.editTotalDataHandler();q=true}}else{if(p.alertTimeReach()=="0"){p.editAlertTimeHandler();q=true}if(p.limitTimeMonth()=="0"){p.editTotalTimeHandler();q=true}}if(q){e(".border-color-transition:visible").addClass("attention-focus");addTimeout(function(){e(".border-color-transition:visible").removeClass("attention-focus")},1500)}return q}},data:{start:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#D8D8D8"}}},alarm:{value:19.7,name:"警戒区",itemStyle:{normal:{color:"#8CC916"}}},alert:{value:1,name:"提醒值",itemStyle:{normal:{color:"#FF5500"}}},free:{value:50,name:"未使用",itemStyle:{normal:{color:"#D8D8D8"}}},left1:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#D8D8D8"}}},used:{value:30,name:"已使用",itemStyle:{normal:{color:"#8CC916"}}},full:{value:30,name:"流量超出",itemStyle:{normal:{color:"#DF4313"}}}},updateEcharts:function(F){var H=0,s=0,y=0,q=0,o=0,z=0;var r=e.i18n.prop("echarts_no");if(k.dataLimitChecked=="1"){c.series[0].data=[];r=e.i18n.prop("echarts_used");if(F.dataLimitTypeChecked()=="1"){c.title.text="";c.series[0].data=[];if(F.limitDataMonth()==0){var D=h.data.used;D.value=1;D.name=e.i18n.prop("echarts_used");D.selected=false;c.series[0].data.push(D)}else{H=F.limitDataMonth()*F.selectedDataUnit()*1048576;s=parseInt(k.monthlySent,10)+parseInt(k.monthlyReceived,10);y=H*F.alertDataReach()/100;if(s>=H){var G=h.data.full;G.value=100;G.name=e.i18n.prop("echarts_full");c.series[0].data.push(G);r=e.i18n.prop("echarts_full")}else{if(y>s){z=y-s;q=H-y}else{o=s-y;q=H-s}var D=h.data.used;if(y-s>0){D.value=s}else{D.value=y}D.name=e.i18n.prop("echarts_used");c.series[0].data.push(D);if(z>0){var x=h.data.left1;x.value=z;x.name=e.i18n.prop("echarts_left1");c.series[0].data.push(x)}var v=h.data.alert;v.value=H/200;v.name=e.i18n.prop("echarts_alert");c.series[0].data.push(v);if(o>0){var t=h.data.alarm;t.value=o;t.name=e.i18n.prop("echarts_alarm");c.series[0].data.push(t)}var w=h.data.free;w.value=q;w.name=e.i18n.prop("echarts_free");c.series[0].data.push(w)}}}else{c.series[0].data=[];if(F.limitTimeMonth()==0){var D=h.data.used;D.value=1;D.selected=false;D.name=e.i18n.prop("echarts_used");c.series[0].data.push(D)}else{H=F.limitTimeMonth()*F.selectedTimeUnit();s=k.monthlyConnectedTime;y=H*F.alertTimeReach()/100;if(s>=H){var u=h.data.full;u.value=100;u.name=e.i18n.prop("echarts_full");c.series[0].data.push(u);r=e.i18n.prop("echarts_full")}else{if(y-s>0){z=y-s;q=H-y}else{o=s-y;q=H-s}var p=h.data.used;if(y-s>0){p.value=s}else{p.value=y}p.name=e.i18n.prop("echarts_used");c.series[0].data.push(p);if(z>0){var E=h.data.left1;E.value=z;E.name=e.i18n.prop("echarts_left1");c.series[0].data.push(E)}var B=h.data.alert;B.value=H/200;B.name=e.i18n.prop("echarts_alert");c.series[0].data.push(B);if(o>0){var A=h.data.alarm;A.value=o;A.name=e.i18n.prop("echarts_alarm");c.series[0].data.push(A)}var C=h.data.free;C.value=q;C.name=e.i18n.prop("echarts_free");c.series[0].data.push(C)}}}}else{var D=h.data.used;D.value=1;D.selected=false;D.name=e.i18n.prop("echarts_no");c.series[0].data=[D];c.title.text=""}h.setEcharts(c,r)},setEcharts:function(r,q){var p=h.data.start;p.value=0;p.selected=false;p.name=q;var o=[p].concat(r.series[0].data);r.series[0].data=o;j.setOption(r,true);addTimeout(function(){j.resize()},1000)}};function m(){j=b.init(e("#traffic_graphic")[0]);window.onresize=j.resize;var o=e("#container");n.cleanNode(o[0]);var q=new l();n.applyBindings(q,o[0]);e("#trafficAlertForm").validate({submitHandler:function(){q.save()},rules:{dataUsed:{decimalRange:true,range:[0,9999]},usedTime:{decimalRange:true,range:[0,9999]},limitDataMonth:{decimalRange:true,range:[1,9999]},limitTimeMonth:{decimalRange:true,range:[1,9999]},alertDataReach:{digits:true,range:[1,100]},alertTimeReach:{digits:true,range:[1,100]}},errorPlacement:function(r,s){if(s.attr("name")=="limitDataMonth"){r.insertAfter("#editTotalDataDiv")}else{if(s.attr("name")=="alertDataReach"){r.insertAfter("#editAlertDataDiv")}else{if(s.attr("name")=="limitTimeMonth"){r.insertAfter("#editTotalTimeDiv")}else{if(s.attr("name")=="alertTimeReach"){r.insertAfter("#editAlertTimeDiv")}else{if(s.attr("name")=="dataUsed"){r.insertAfter("#editUsedDataDiv")}else{if(s.attr("name")=="usedTime"){r.insertAfter("#editUsedTimeDiv")}else{r.insertAfter(s)}}}}}}}});var p=window.language;window.setInterval(function(){if(p!=window.language){p=window.language;h.updateEcharts(q)}},1000)}return{init:m}});