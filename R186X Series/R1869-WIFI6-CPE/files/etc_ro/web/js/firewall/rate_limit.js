define(["jquery","knockout","config/config","service","underscore"],function(c,j,a,d,g){var e=g.map(a.MAP_PROTOCOL_MODES,function(k){return new Option(k.name,k.value)});var b=[{columnType:"checkbox",rowText:"index",width:"8%"},{headerTextTrans:"ip_address",rowText:"ip_address",width:"20%"},{headerTextTrans:"download_speed",rowText:"download_speed",width:"20%"},{headerTextTrans:"upload_speed",rowText:"upload_speed",width:"20%"},{headerTextTrans:"comment",rowText:"comment",width:"20%"}];function h(){var l=this;var m=f();l.RatelimitEnable=j.observable(m.RatelimitEnable);l.oriRatelimitEnable=j.observable(m.RatelimitEnable);l.ip_address=j.observable("");l.download_speed=j.observable("");l.upload_speed=j.observable("");l.comment=j.observable("");l.rules=j.observableArray(m.RatelimitRules);l.gridTemplate=new j.simpleGrid.viewModel({data:l.rules(),idName:"index",columns:b,tmplType:"list",pageSize:10});l.callback=function(n){if(n.result=="success"){k();i(l);successOverlay()}else{errorOverlay()}};function k(){l.ip_address("");l.download_speed("");l.upload_speed("");l.comment("")}l.enableRatelimit=function(){showConfirm("confirm_restart",function(){showLoading();var n={};n.RatelimitEnable=l.RatelimitEnable();d.enableRatelimit(n,l.callback)})};l.save=function(){if(l.rules().length>=a.portForwardMax){showAlert({msg:"rules_max",params:a.portForwardMax});return}if(l.checkExist()){showAlert("rule_exist");return}showLoading();var n={};n.RatelimitEnable=l.RatelimitEnable();n.ip_address=l.ip_address();n.download_speed=l.download_speed();n.upload_speed=l.upload_speed();n.comment=l.comment();d.setRatelimit(n,l.callback)};l.checkExist=function(){var o={ip_address:l.ip_address()};var q;var p=l.rules();for(var n=0;n<p.length;n++){q={ip_address:p[n].ip_address};if(g.isEqual(o,q)){return true}}return false};l.deleteLimitRules=function(){var n=l.gridTemplate.selectedIds();if(n.length==0){showAlert("no_data_selected");return}showConfirm("confirm_data_delete",function(){showLoading();var o={};o.indexs=n;d.deleteLimitRules(o,l.callback)})}}function f(){return d.getRatelimit()}function i(l){var m;if(l){m=l;var n=f();m.RatelimitEnable(n.RatelimitEnable);m.oriRatelimitEnable(n.RatelimitEnable);m.rules(n.RatelimitRules);m.gridTemplate.clearAllChecked();m.gridTemplate.data(n.RatelimitRules);refreshTableHeight();renderCheckbox();return}m=new h();var k=c("#container");j.cleanNode(k[0]);j.applyBindings(m,k[0]);fixTableHeight();c("#RatelimitBasicForm").validate({submitHandler:function(){m.enableRatelimit()}});c("#RatelimitListForm").validate({submitHandler:function(){m.deleteLimitRules()}});c("#RatelimitForm").validate({submitHandler:function(){m.save()},rules:{txtIpAddress:{ip_check:true},txtDownloadSpeed:{digits:true,range:[1,15000]},txtUploadSpeed:{digits:true,range:[1,15000]},txtComment:{comment_check:true}},errorPlacement:function(o,p){if(p.attr("name")=="txtIpAddress"){o.appendTo("#txtIpAddressErrorDiv")}else{if(p.attr("name")=="txtDownloadSpeed"){o.appendTo("#txtDownloadSpeedErrorDiv")}else{if(p.attr("name")=="txtUploadSpeed"){o.appendTo("#txtUploadSpeedErrorDiv")}else{o.insertAfter(p)}}}}})}return{init:i}});