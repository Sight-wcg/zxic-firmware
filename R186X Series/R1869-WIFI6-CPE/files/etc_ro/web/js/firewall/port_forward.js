define(["jquery","knockout","config/config","service","underscore"],function(c,i,a,e,g){var f=g.map(a.FORWARD_PROTOCOL_MODES,function(k){return new Option(k.name,k.value)});var b=[{columnType:"checkbox",rowText:"index",width:"8%"},{headerTextTrans:"ip_address",rowText:"ipAddress",width:"23%"},{headerTextTrans:"port_range",rowText:"portRange",width:"23%"},{headerTextTrans:"protocol",rowText:"protocol",width:"23%"},{headerTextTrans:"comment",rowText:"comment",width:"23%"}];function d(){var l=this;var m=j();l.portForwardEnable=i.observable(m.portForwardEnable);l.oriPortForwardEnable=i.observable(m.portForwardEnable);l.ipAddress=i.observable("");l.portStart=i.observable("");l.portEnd=i.observable("");l.modes=i.observableArray(f);l.selectedMode=i.observable("3");l.comment=i.observable("");l.rules=i.observableArray(m.portForwardRules);l.gridTemplate=new i.simpleGrid.viewModel({data:l.rules(),idName:"index",columns:b,tmplType:"list",pageSize:10});l.callback=function(n){if(n.result=="success"){k();h(l);successOverlay()}else{errorOverlay()}};function k(){l.ipAddress("");l.portStart("");l.portEnd("");l.selectedMode("TCP&UDP");l.comment("")}l.enableVirtualServer=function(){showLoading();var n={};n.portForwardEnable=l.portForwardEnable();e.enableVirtualServer(n,l.callback)};l.save=function(){if(l.rules().length>=a.portForwardMax){showAlert({msg:"rules_max",params:a.portForwardMax});return}if(l.checkExist()){showAlert("rule_exist");return}showLoading();var n={};n.ipAddress=l.ipAddress();n.portStart=l.portStart();n.portEnd=l.portEnd();n.protocol=l.selectedMode();n.comment=l.comment();e.setPortForward(n,l.callback)};l.checkExist=function(){var o={ipAddress:l.ipAddress(),portRange:l.portStart()+" - "+l.portEnd(),protocol:transProtocolValue(l.selectedMode())};var q;var p=l.rules();for(var n=0;n<p.length;n++){q={ipAddress:p[n].ipAddress,portRange:p[n].portRange,protocol:p[n].protocol};if(g.isEqual(o,q)){return true}}return false};l.deleteForwardRules=function(){var n=l.gridTemplate.selectedIds();if(n.length==0){showAlert("no_data_selected");return}showConfirm("confirm_data_delete",function(){showLoading("deleting");var o={};o.indexs=n;e.deleteForwardRules(o,l.callback)})}}function j(){return e.getPortForward()}function h(l){var m;if(l){m=l;var n=j();m.portForwardEnable(n.portForwardEnable);m.oriPortForwardEnable(n.portForwardEnable);m.rules(n.portForwardRules);m.gridTemplate.clearAllChecked();m.gridTemplate.data(n.portForwardRules);refreshTableHeight();return}m=new d();var k=c("#container");i.cleanNode(k[0]);i.applyBindings(m,k[0]);fixTableHeight();renderCheckbox();c("#virtualServerForm").validate({submitHandler:function(){m.enableVirtualServer()}});c("#portForwardListForm").validate({submitHandler:function(){m.deleteForwardRules()}});c("#portForwardForm").validate({submitHandler:function(){m.save()},rules:{txtIpAddress:{ip_check:true},txtPortStart:{digits:true,range:[1,65535],portCompare:"#txtPortEnd"},txtPortEnd:{digits:true,range:[1,65535],portCompare:"#txtPortStart"},txtComment:{comment_check:true}},groups:{range:"txtPortStart txtPortEnd"},errorPlacement:function(o,p){if(p.attr("name")=="txtIpAddress"){o.appendTo("#ipErrorDiv")}else{if(p.attr("name")=="txtPortStart"||p.attr("name")=="txtPortEnd"){o.appendTo("#portRangeErrorDiv")}else{o.insertAfter(p)}}}})}return{init:h}});