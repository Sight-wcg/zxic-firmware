define(["knockout","service","jquery","config/config","underscore","status/statusBar","echarts"],function(o,g,f,b,k,j,d){var l={CONNECTED:1,DISCONNECTED:2,CONNECTING:3,DISCONNECTING:4};var p={WIRELESS:1,CABLE:2,AUTO:3};var h=null;var a=0;var i=window.language;var e={tooltip:{formatter:"{b}"},title:{text:"",x:"center",y:"center",itemGap:0,textStyle:{color:"#FFF",fontFamily:"微软雅黑",fontSize:20,fontWeight:"bolder"},subtextStyle:{color:"#FFF",fontFamily:"微软雅黑",fontSize:16,fontWeight:"bolder"}},animation:false,series:[{name:"流量控制",type:"pie",radius:["0","72"],itemStyle:{normal:{label:{show:false},labelLine:{show:false}}},data:[],selectedOffset:3}],color:["red","red","red","red","red"]};function c(){var q=this;q.hasSms=b.HAS_SMS;q.hasPhonebook=b.HAS_PHONEBOOK;q.isSupportSD=b.SD_CARD_SUPPORT;q.isCPE=b.PRODUCT_TYPE=="CPE";q.hasRj45=b.RJ45_SUPPORT;q.notDataCard=b.PRODUCT_TYPE!="DATACARD";q.hasParentalControl=b.HAS_PARENTAL_CONTROL;var t=g.getWifiBasic();if(b.WIFI_SUPPORT_QR_SWITCH){q.showQRCode=b.WIFI_SUPPORT_QR_CODE&&t.show_qrcode_flag}else{q.showQRCode=b.WIFI_SUPPORT_QR_CODE}q.qrcodeSrc="./pic/qrcode_ssid_wifikey.png?_="+f.now();if(q.hasRj45){var s=checkCableMode(g.getOpMode().blc_wan_mode);q.opCurMode=o.observable(s);q.isShowHomeConnect=o.observable(!s);q.showTraffic=o.observable(b.TRAFFIC_SUPPORT&&!s);q.isSupportQuicksetting=o.observable(b.HAS_QUICK_SETTING&&!s)}else{q.isShowHomeConnect=o.observable(true);q.showTraffic=o.observable(b.TRAFFIC_SUPPORT);q.isSupportQuicksetting=o.observable(b.HAS_QUICK_SETTING)}if(b.PRODUCT_TYPE=="DATACARD"){f("#home_image").addClass("data-card")}var u=g.getConnectionInfo();q.networkType=o.observable(n.getNetworkType(u.networkType));q.connectStatus=o.observable(u.connectStatus);q.canConnect=o.observable(false);q.cStatus=o.computed(function(){if(q.connectStatus().indexOf("_connected")!=-1){return l.CONNECTED}else{if(q.connectStatus().indexOf("_disconnecting")!=-1){return l.DISCONNECTING}else{if(q.connectStatus().indexOf("_connecting")!=-1){return l.CONNECTING}else{return l.DISCONNECTED}}}});q.current_Flux=o.observable(transUnit(0,false));q.connected_Time=o.observable(transSecond2Time(0));q.up_Speed=o.observable(transUnit(0,true));q.down_Speed=o.observable(transUnit(0,true));q.isLoggedIn=o.observable(false);q.enableFlag=o.observable(true);q.simSerialNumber=o.observable("");q.imei=o.observable("");q.imsi=o.observable("");q.ssid=o.observable("");q.hasWifi=b.HAS_WIFI;q.showMultiSsid=o.observable(b.HAS_MULTI_SSID&&t.multi_ssid_enable=="1");q.trafficAlertEnable=o.observable(false);q.trafficUsed=o.observable("");q.trafficLimited=o.observable("");q.wireDeviceNum=o.observable(g.getAttachedCableDevices().attachedDevices.length);q.wirelessDeviceNum=o.observable(g.getStatusInfo().wirelessDeviceNum);q.showOpModeWindow=function(){if(q.enableFlag()){return}showSettingWindow("change_mode","opmode/opmode_popup","opmode/opmode_popup",400,300,function(){})};q.currentOpMode=o.observable("0");var v=false;f("#showDetailInfo").popover({html:true,placement:"top",trigger:"focus",title:function(){return f.i18n.prop("device_info")},content:function(){return w()}}).on("shown.bs.popover",function(){v=true}).on("hidden.bs.popover",function(){v=false});function r(){var x=g.getDeviceInfo();q.simSerialNumber(verifyDeviceInfo(x.simSerialNumber));q.imei(verifyDeviceInfo(x.imei));q.imsi(verifyDeviceInfo(x.imsi));q.ssid(verifyDeviceInfo(x.ssid));q.showMultiSsid(b.HAS_MULTI_SSID&&x.multi_ssid_enable=="1");return x}r();function w(){var z=r();n.initShownStatus(z);var x=n.getWanIpAddr(z);var A=k.template(f("#detailInfoTmpl").html());var y=A({simSerialNumber:verifyDeviceInfo(z.simSerialNumber),imei:verifyDeviceInfo(z.imei),imsi:verifyDeviceInfo(z.imsi),sn:verifyDeviceInfo(z.sn),wifi_mac:verifyDeviceInfo(z.wifi_mac),pci:verifyDeviceInfo(z.remo_pci),iccid:verifyDeviceInfo(z.iccid),cellid:verifyDeviceInfo(z.remo_cellid),rsrq:verifyDeviceInfo(z.remo_rsrq),band:verifyDeviceInfo(z.remo_band),rsrp:verifyDeviceInfo(z.remo_rsrp),sinr:verifyDeviceInfo(z.remo_sinr),rssi:verifyDeviceInfo(z.remo_rssi),rscp:verifyDeviceInfo(z.remo_rscp),arfcn:verifyDeviceInfo(z.remo_arfcn),snr:verifyDeviceInfo(z.snr),signal:signalFormat(z.signal),hasWifi:b.HAS_WIFI,isCPE:b.PRODUCT_TYPE=="CPE",hasRj45:b.RJ45_SUPPORT,showMultiSsid:b.HAS_MULTI_SSID&&z.multi_ssid_enable=="1",ssid:verifyDeviceInfo(z.ssid),max_access_num:verifyDeviceInfo(z.max_access_num),m_ssid:verifyDeviceInfo(z.m_ssid),m_max_access_num:verifyDeviceInfo(z.m_max_access_num),wifi_long_mode:"wifi_des_"+z.wifiRange,lanDomain:verifyDeviceInfo(z.lanDomain),ipAddress:verifyDeviceInfo(z.ipAddress),showMacAddress:b.SHOW_MAC_ADDRESS,macAddress:verifyDeviceInfo(z.macAddress),showIpv4WanIpAddr:n.initStatus.showIpv4WanIpAddr,wanIpAddress:x.wanIpAddress,showIpv6WanIpAddr:n.initStatus.showIpv6WanIpAddr,ipv6WanIpAddress:x.ipv6WanIpAddress,sw_version:verifyDeviceInfo(z.sw_version),hw_version:verifyDeviceInfo(z.hw_version)});return f(y).translate()}q.connectHandler=function(){if(q.connectStatus()=="ppp_connected"){showLoading("disconnecting");g.disconnect({},function(x){if(x.result){successOverlay()}else{errorOverlay()}})}else{if(g.getStatusInfo().roamingStatus){showConfirm("dial_roaming_connect",function(){q.connect()})}else{q.connect()}}};q.connect=function(){var y=g.getStatusInfo();var z=j.getTrafficResult(y);if(y.limitVolumeEnable&&z.showConfirm){var x=null;if(z.usedPercent>100){x={msg:"traffic_beyond_connect_msg"};j.setTrafficAlertPopuped(true)}else{x={msg:"traffic_limit_connect_msg",params:[z.limitPercent]};j.setTrafficAlert100Popuped(false)}showConfirm(x,function(){n.doConnect()})}else{n.doConnect()}};g.getSignalStrength({},function(y){var x=signalFormat(convertSignal(y));f("#fresh_signal_strength").text(x);if(v){f("#popoverSignalTxt").text(x)}});n.refreshHomeData(q);addInterval(function(){g.getSignalStrength({},function(y){var x=signalFormat(convertSignal(y));f("#fresh_signal_strength").text(x);if(v){f("#popoverSignalTxt").text(x)}});n.refreshHomeData(q)},1000);addInterval(function(){g.get_net_status({},function(y){var x={};x.arfcn=y.remo_arfcn;x.pci=y.remo_pci;x.cellid=y.remo_cellid;x.band=y.remo_band;x.rssi=y.remo_rssi;x.rsrp=y.remo_rsrp;x.sinr=y.remo_sinr;x.rsrq=y.remo_rsrq;x.rscp=y.remo_rscp;if(v){f("#arfcnTxt").text(x.arfcn);f("#pciTxt").text(x.pci);f("#cellidTxt").text(x.cellid);f("#rssiTxt").text(x.rssi);f("#rscpTxt").text(x.rscp);f("#rsrqTxt").text(x.rsrq);f("#bandTxt").text(x.band);f("#rsrpTxt").text(x.rsrp);f("#sinrTxt").text(x.sinr)}})},2000);if(q.hasRj45){n.refreshOpmodeInfo(q);addInterval(function(){n.refreshOpmodeInfo(q)},1000)}q.showNetworkSettingsWindow=function(){if(q.hasRj45){g.getOpMode({},function(x){var y=checkCableMode(x.blc_wan_mode);if(y){window.location.hash="#net_setting"}else{window.location.hash="#dial_setting"}})}else{window.location.hash="#dial_setting"}}}var n={initStatus:null,initShownStatus:function(q){this.initStatus={};var r=q.ipv6PdpType.toLowerCase().indexOf("v6")>0;if(b.RJ45_SUPPORT){var s=checkCableMode(q.blc_wan_mode);if(s){this.initStatus.showIpv6WanIpAddr=false;this.initStatus.showIpv4WanIpAddr=true}else{if(b.IPV6_SUPPORT){if(q.pdpType=="IP"){this.initStatus.showIpv6WanIpAddr=false;this.initStatus.showIpv4WanIpAddr=true}else{if(r){if(q.ipv6PdpType=="IPv6"){this.initStatus.showIpv6WanIpAddr=true;this.initStatus.showIpv4WanIpAddr=false}else{this.initStatus.showIpv6WanIpAddr=true;this.initStatus.showIpv4WanIpAddr=true}}}}else{this.initStatus.showIpv6WanIpAddr=false;this.initStatus.showIpv4WanIpAddr=true}}}else{if(b.IPV6_SUPPORT){if(q.pdpType=="IP"){this.initStatus.showIpv6WanIpAddr=false;this.initStatus.showIpv4WanIpAddr=true}else{if(r){if(q.ipv6PdpType=="IPv6"){this.initStatus.showIpv6WanIpAddr=true;this.initStatus.showIpv4WanIpAddr=false}else{this.initStatus.showIpv6WanIpAddr=true;this.initStatus.showIpv4WanIpAddr=true}}}}else{this.initStatus.showIpv6WanIpAddr=false;this.initStatus.showIpv4WanIpAddr=true}}},getWanIpAddr:function(r){var q={wanIpAddress:"",ipv6WanIpAddress:""};q.wanIpAddress=verifyDeviceInfo(r.wanIpAddress);q.ipv6WanIpAddress=verifyDeviceInfo(r.ipv6WanIpAddress);return q},cachedAPStationBasic:null,cachedConnectionMode:null,getCanConnectNetWork:function(s){var q=g.getStatusInfo();if(q.simStatus!="modem_init_complete"){return false}var r=q.networkType.toLowerCase();if(r=="searching"){return false}if(r==""||r=="limited service"){r="limited_service"}if(r=="no service"){r="no_service"}if(r=="limited_service"||r=="no_service"){if(s.cStatus()!=l.CONNECTED){return false}}if(b.AP_STATION_SUPPORT){if(q.connectWifiStatus=="connect"){if(q.ap_station_mode=="wifi_pref"){return false}}}return true},doConnect:function(){showLoading("connecting");g.connect({},function(q){if(q.result){successOverlay()}else{errorOverlay()}})},refreshHomeData:function(q){var r=g.getConnectionInfo();q.connectStatus(r.connectStatus);q.canConnect(this.getCanConnectNetWork(q));q.networkType(n.getNetworkType(r.networkType));if(r.connectStatus=="ppp_connected"){q.current_Flux(transUnit(parseInt(r.data_counter.currentReceived,10)+parseInt(r.data_counter.currentSent,10),false));q.connected_Time(transSecond2Time(r.data_counter.currentConnectedTime));q.up_Speed(transUnit(r.data_counter.uploadRate,true));q.down_Speed(transUnit(r.data_counter.downloadRate,true))}else{q.current_Flux(transUnit(0,false));q.connected_Time(transSecond2Time(0));q.up_Speed(transUnit(0,true));q.down_Speed(transUnit(0,true))}q.trafficAlertEnable(r.limitVolumeEnable);if(r.limitVolumeEnable){if(r.limitVolumeType=="1"){q.trafficUsed(transUnit(parseInt(r.data_counter.monthlySent,10)+parseInt(r.data_counter.monthlyReceived,10),false));q.trafficLimited(transUnit(r.limitDataMonth,false))}else{q.trafficUsed(transSecond2Time(r.data_counter.monthlyConnectedTime));q.trafficLimited(transSecond2Time(r.limitTimeMonth))}}if(i!=window.language){i=window.language;a=1}if(q.showTraffic()){n.updateEcharts(r)}else{n.allFreeEcharts()}n.refreshStationInfo(q)},allFreeEcharts:function(){var q=n.data.free;q.value=1;q.selected=false;q.name=f.i18n.prop("echarts_no");e.series[0].data=[q];e.title.text="";n.setEcharts(e,f.i18n.prop("echarts_no"))},getNetworkType:function(r){var q=r.toLowerCase();if(q==""||q=="limited service"){q="limited_service"}if(q=="no service"){q="no_service"}if(q=="limited_service"||q=="no_service"){return f.i18n.prop("network_type_"+q)}else{return r}},data:{start:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#3484e3"}}},alarm:{value:19.7,name:"警戒区",itemStyle:{normal:{color:"#e8df8d"}}},alert:{value:1,name:"提醒值",itemStyle:{normal:{color:"#FF5500"}}},free:{value:50,name:"未使用",itemStyle:{normal:{color:"#3484e3"}}},left1:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#3484e3"}}},used:{value:30,name:"已使用",itemStyle:{normal:{color:"#e8df8d"}}},notset:{value:30,name:"未设置",itemStyle:{normal:{color:"#3484e3"}}},full:{value:30,name:"流量超出",itemStyle:{normal:{color:"#DF4313"}}}},oldUsedData:null,oldAlarmData:null,updateEcharts:function(K){var u=f.i18n.prop("echarts_no");a++;if(a%10!=2){return false}var N=0,v=0,C=0,t=0,q=0,D=0;if(K.limitVolumeEnable){u=f.i18n.prop("echarts_used");e.series[0].data=[];if(K.limitVolumeType=="1"){var L=transUnit(K.limitDataMonth,false);e.series[0].data=[];if(K.limitDataMonth==0){var I=n.data.used;I.value=1;I.selected=false;I.name=f.i18n.prop("echarts_used");e.series[0].data.push(I)}else{var z=n.getDataInfo(L);N=z.data*n.getUnitValue(z.unit)*1048576;v=parseInt(K.data_counter.monthlySent,10)+parseInt(K.data_counter.monthlyReceived,10);C=N*K.limitVolumePercent/100;if(v>=N){var M=n.data.full;M.value=100;M.name=f.i18n.prop("echarts_full");e.series[0].data.push(M);u=f.i18n.prop("echarts_full")}else{if(C-v>0){D=C-v;t=N-C}else{q=v-C;t=N-v}var I=n.data.used;if(C-v>0){I.value=v}else{I.value=C}I.name=f.i18n.prop("echarts_used");e.series[0].data.push(I);if(D>0){var B=n.data.left1;B.value=D;B.name=f.i18n.prop("echarts_left1");e.series[0].data.push(B)}var y=n.data.alert;y.value=N/200;y.name=f.i18n.prop("echarts_alert");e.series[0].data.push(y);if(q>0){var w=n.data.alarm;w.value=q;w.name=f.i18n.prop("echarts_alarm");e.series[0].data.push(w)}var A=n.data.free;A.value=t;A.name=f.i18n.prop("echarts_free");e.series[0].data.push(A)}}}else{e.series[0].data=[];if(K.limitTimeMonth==0){var I=n.data.used;I.value=1;I.selected=false;I.name=f.i18n.prop("echarts_used");e.series[0].data.push(I)}else{N=K.limitTimeMonth;v=K.data_counter.monthlyConnectedTime;C=N*K.limitVolumePercent/100;if(v>=N){var x=n.data.full;x.value=100;x.name=f.i18n.prop("echarts_full");e.series[0].data.push(x);u=f.i18n.prop("echarts_full")}else{if(C-v>0){D=C-v;t=N-C}else{q=v-C;t=N-v}var r=n.data.used;if(C-v>0){r.value=v}else{r.value=C}r.name=f.i18n.prop("echarts_used");e.series[0].data.push(r);if(D>0){var J=n.data.left1;J.value=D;J.name=f.i18n.prop("echarts_left1");e.series[0].data.push(J)}var G=n.data.alert;G.value=N/200;G.name=f.i18n.prop("echarts_alert");e.series[0].data.push(G);if(q>0){var E=n.data.alarm;E.value=q;E.name=f.i18n.prop("echarts_alarm");e.series[0].data.push(E)}var H=n.data.free;H.value=t;H.name=f.i18n.prop("echarts_free");e.series[0].data.push(H)}}}}else{var I=n.data.notset;I.value=1;I.selected=false;I.name=f.i18n.prop("echarts_no");e.series[0].data=[I];e.title.text=""}var s=k.find(e.series[0].data,function(O){return O.name==f.i18n.prop("echarts_used")});var F=k.find(e.series[0].data,function(O){return O.name==f.i18n.prop("echarts_alarm")});if(!F){F={value:0}}if(typeof s=="undefined"){n.setEcharts(e,u)}else{if(n.oldUsedData!=s.value||n.oldAlarmData!=F.value){n.oldUsedData=s.value;n.oldAlarmData=F.value;n.setEcharts(e,u)}}},setEcharts:function(t,s){var r=n.data.start;r.value=0;r.name=s;r.selected=false;var q=[r].concat(t.series[0].data);t.series[0].data=q;h.setOption(t,true);addTimeout(function(){h.resize()},1000)},getUnit:function(q){if(q=="1024"){return"GB"}else{if(q=="1048576"){return"TB"}else{return"MB"}}},getUnitValue:function(q){q=q.toUpperCase();if(q=="GB"){return"1024"}else{if(q=="TB"){return"1048576"}else{return"1"}}},getDataInfo:function(q){return{data:/\d+(.\d+)?/.exec(q)[0],unit:/[A-Z]{1,2}/.exec(q)[0]}},refreshStationInfo:function(q){q.wirelessDeviceNum(g.getStatusInfo().wirelessDeviceNum);if(a%10==2){g.getAttachedCableDevices({},function(r){q.wireDeviceNum(r.attachedDevices.length)})}},refreshOpmodeInfo:function(q){var v=g.getOpMode();q.isLoggedIn(v.loginfo=="ok");var u=checkCableMode(v.blc_wan_mode);if(q.opCurMode()&&!u){var t=g.getLoginData();var s=t.modem_main_state;if(s=="modem_sim_undetected"||s=="modem_undetected"||s=="modem_sim_destroy"||s=="modem_waitpin"||s=="modem_waitpuk"||s=="modem_imsi_waitnck"){window.location.reload();return}}q.opCurMode(u);if(u&&v.ethwan_mode=="DHCP"){q.enableFlag(false)}else{if((!u&&v.ppp_status!="ppp_disconnected")||(u&&v.rj45_state!="idle"&&v.rj45_state!="dead")){q.enableFlag(true)}else{q.enableFlag(false)}}var w=(v.blc_wan_mode=="AUTO_PPP"||v.blc_wan_mode=="AUTO_PPPOE")?"AUTO":v.blc_wan_mode;var r="";switch(w){case"AUTO":r="opmode_auto";break;case"PPPOE":r="opmode_cable";break;case"PPP":r="opmode_gateway";break;default:break}f("#opmode").attr("data-trans",r).text(f.i18n.prop(r));q.isShowHomeConnect(!u);q.showTraffic(b.TRAFFIC_SUPPORT&&!u);q.isSupportQuicksetting(b.HAS_QUICK_SETTING&&!u)}};function m(){a=0;n.oldUsedData=null;n.oldAlarmData=null;h=d.init(f("#traffic_graphic")[0]);var q=f("#container")[0];o.cleanNode(q);var r=new c();o.applyBindings(r,q)}return{init:m}});