define(["jquery","knockout","config/config","service","underscore"],function(f,c,r,u,t){function h(){return t.map(r.APN_AUTH_MODES,function(v){return new Option(v.name,v.value)})}function q(){var v=[new Option("IPv4","IP")];if(r.IPV6_SUPPORT){v.push(new Option("IPv6","IPv6"));if(r.IPV4V6_SUPPORT){v.push(new Option("IPv4v6","IPv4v6"))}if(r.IPV4_AND_V6_SUPPORT){v.push(new Option("IPv4 & IPv6","IPv4v6"))}}return v}function s(){var v=u.getApnSettings();v.ipv6ApnConfigs=o(v.ipv6APNs,true);v.apnConfigs=o(v.APNs,false);v.autoApnConfigs=e(v.autoApns,v.autoApnsV6);return v}function k(){return u.getReservedCid()}var j={};var d={};var b={};function o(v,z){var B=[];var x={};if(v&&v.length>10){var w=v.split("||");for(var A=0;A<w.length;A++){if(w[A]!=""){var y=g(w[A],z);B.push(y);x[y.profileName]=y}}}if(z){d=x}else{j=x}return B}function e(A,y){var B=[];var z=[];if(A&&A.length>5){var v=A.split("||");for(var x=0;x<v.length;x++){if(v[x]!=""){var w=g(v[x],false);B.push(w)}}}if(y&&y.length>5){var v=y.split("||");for(var x=0;x<v.length;x++){if(v[x]!=""){var w=g(v[x],false);z.push(w)}}}return l(B,z)}function l(y,x){b={};var A=[];for(var w=0;w<y.length;w++){var v=y[w];var z=x[w];if(z&&(z.pdpType=="IPv6"||z.pdpType=="IPv4v6")){v.wanApnV6=z.wanApn;v.authModeV6=z.authMode;v.usernameV6=z.username;v.passwordV6=z.password;v.dnsModeV6=z.dnsMode;v.dns1V6=z.dns1;v.dns2V6=z.dns2}A.push(v);b[v.profileName]=v}return A}function g(z,x){var v={};var w=z.split("($)");for(var y=0;y<w.length;y++){v.profileName=w[0];v.pdpType=w[7];if(x){v.wanApnV6=w[1];v.authModeV6=w[4].toLowerCase();v.usernameV6=w[5];v.passwordV6=w[6];v.dnsModeV6=w[10];v.dns1V6=w[11];v.dns2V6=w[12]}else{v.wanApn=w[1];v.authMode=w[4].toLowerCase();v.username=w[5];v.password=w[6];v.dnsMode=w[10];v.dns1=w[11];v.dns2=w[12]}}return v}function p(v){return t.map(v,function(w){return new Option(w.profileName,w.profileName)})}function m(){var F=this;var w=s();var z=k();if(w.apnNumPreset){r.maxApnNumber=w.apnNumPreset}F.showApnDns=c.observable(r.SHOW_APN_DNS);F.index=c.observable(w.currIndex);F.supportIPv6=c.observable(r.IPV6_SUPPORT);F.supportIpv4AndIpv6=c.observable(r.IPV4_AND_V6_SUPPORT);F.defApn=c.observable(w.profileName);F.apnMode=c.observable(w.apnMode);F.autoProfiles=c.observableArray(p(w.autoApnConfigs));F.profiles=c.observableArray(p(w.apnConfigs));F.wanDial=c.observable(w.wanDial);F.pdpTypes=c.observableArray(q());F.selectedPdpType=c.observable(w.pdpType);F.selectedPdpTypeTmp=c.observable(w.pdpType);F.profileName=c.observable(w.profileName);F.selectedProfile=c.observable(w.profileName);F.apn=c.observable(w.wanApn);F.dnsMode=c.observable(w.dnsMode=="manual"?"manual":"auto");F.dns1=c.observable(w.dns1);F.dns2=c.observable(w.dns2);F.authModes=c.observableArray(h());F.username=c.observable(w.username);F.password=c.observable(w.password);F.apnV6=c.observable(w.wanApnV6);F.dnsModeV6=c.observable(w.dnsModeV6=="manual"?"manual":"auto");F.dns1V6=c.observable(w.dns1V6);F.dns2V6=c.observable(w.dns2V6);F.authModesV6=c.observableArray(h());F.usernameV6=c.observable(w.usernameV6);F.passwordV6=c.observable(w.passwordV6);F.pdpTypeNote=c.observable(true);F.cid_reserved=c.observable(z.cid_reserved);if(w.autoApnConfigs&&w.autoApnConfigs.length>0){F.selectedAutoProfile=c.observable(w.autoApnConfigs[0].profileName)}else{F.selectedAutoProfile=c.observable()}if(r.EMPTY_APN_SUPPORT){f("#apn_ipv4_apn").removeClass("required");f("#apn_ipv6_apn").removeClass("required")}else{f("#apn_ipv4_apn").addClass("required");f("#apn_ipv6_apn").addClass("required")}F.selectedAuthentication=c.observable(w.authMode);F.selectedAuthenticationV6=c.observable(w.authModeV6);F.disableProfile=c.observable(false);F.addApnHide=c.observable(true);F.defaultCfg=c.observable(true);F.predeterminedCfg=c.observable(true);F.transApn=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_ipv4_apn":"apn");F.transDnsMode=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_dns_mode_ipv4":"apn_dns_mode");F.transDns1=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_dns1_ipv4":"apn_dns1");F.transDns2=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_dns2_ipv4":"apn_dns2");F.transAuth=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_authentication_ipv4":"apn_authentication");F.transUserName=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_user_name_ipv4":"apn_user_name");F.transPassword=c.observable(r.IPV4_AND_V6_SUPPORT?"apn_password_ipv4":"apn_password");F.transApnV6=c.observable("apn");F.transDnsModeV6=c.observable("apn_dns_mode");F.transDns1V6=c.observable("apn_dns1");F.transDns2V6=c.observable("apn_dns2");F.transAuthV6=c.observable("apn_authentication");F.transUserNameV6=c.observable("apn_user_name");F.transPasswordV6=c.observable("apn_password");F.setDefaultVisible=c.observable(!a());F.tmp1=c.computed(function(){if(F.selectedPdpType()=="IP"||F.selectedPdpType()=="IPv4"){F.transApn("apn");F.transDnsMode("apn_dns_mode");F.transDns1("apn_dns1");F.transDns2("apn_dns2");F.transAuth("apn_authentication");F.transUserName("apn_user_name");F.transPassword("apn_password")}else{if(F.selectedPdpType()=="IPv6"){F.transApnV6("apn");F.transDnsModeV6("apn_dns_mode");F.transDns1V6("apn_dns1");F.transDns2V6("apn_dns2");F.transAuthV6("apn_authentication");F.transUserNameV6("apn_user_name");F.transPasswordV6("apn_password")}else{if(r.IPV4_AND_V6_SUPPORT&&F.selectedPdpType()=="IPv4v6"){F.transApn("apn_ipv4_apn");F.transDnsMode("apn_dns_mode_ipv4");F.transDns1("apn_dns1_ipv4");F.transDns2("apn_dns2_ipv4");F.transAuth("apn_authentication_ipv4");F.transUserName("apn_user_name_ipv4");F.transPassword("apn_password_ipv4");F.transApnV6("apn_ipv6_apn");F.transDnsModeV6("apn_dns_mode_ipv6");F.transDns1V6("apn_dns1_ipv6");F.transDns2V6("apn_dns2_ipv6");F.transAuthV6("apn_authentication_ipv6");F.transUserNameV6("apn_user_name_ipv6");F.transPasswordV6("apn_password_ipv6")}else{F.transApn("apn");F.transDnsMode("apn_dns_mode");F.transDns1("apn_dns1");F.transDns2("apn_dns2");F.transAuth("apn_authentication");F.transUserName("apn_user_name");F.transPassword("apn_password")}}}f("#apn_setting_form").translate()});F.hasCapacity=c.computed(function(){if(F.profiles().length>=r.maxApnNumber){return false}else{return true}});F.autoApnChecked=c.computed(function(){return F.apnMode()=="auto"});F.showDns=c.computed(function(){return F.dnsMode()=="manual"});F.showDnsV6=c.computed(function(){return F.dnsModeV6()=="manual"});C();F.checkInputDisable=c.computed(function(){if(F.apnMode()!="auto"&&!a()&&(F.predeterminedCfg()==false&&F.defaultCfg()==true)){return false}if(F.apnMode()=="auto"||((F.apnMode()!="auto"&&(F.predeterminedCfg()||F.defaultCfg())&&!F.disableProfile()))){return true}if(F.apnMode()!="auto"&&(!F.disableProfile()||!(F.predeterminedCfg()||F.defaultCfg()))){return false}return false});var x=u.getDeviceInfo();F.pdpTypeChangeAlert=function(){if(F.pdpTypeNote()){showAlert({msg:"apn_pdptype_change_note",params:[x.lanDomain,x.ipAddress]})}if(F.apnMode()!="auto"&&!F.disableProfile()){if((r.IPV4_AND_V6_SUPPORT&&F.selectedPdpTypeTmp()!="IPv4v6"&&F.selectedPdpType()!="IPv4v6")||!r.IPV4_AND_V6_SUPPORT){if(F.selectedPdpTypeTmp()=="IPv6"){F.apn(F.apnV6());F.dnsMode(F.dnsModeV6());F.dns1(F.dns1V6());F.dns2(F.dns2V6());F.username(F.usernameV6());F.password(F.passwordV6());F.selectedAuthentication(F.selectedAuthenticationV6())}else{if(F.selectedPdpType()=="IPv6"){F.apnV6(F.apn());F.dnsModeV6(F.dnsMode());F.dns1V6(F.dns1());F.dns2V6(F.dns2());F.usernameV6(F.username());F.passwordV6(F.password());F.selectedAuthenticationV6(F.selectedAuthentication())}}}}F.selectedPdpTypeTmp(F.selectedPdpType())};F.showAutoApnDetail=c.computed(function(){if(F.apnMode()=="auto"){return F.autoProfiles().length>0}else{return true}});F.profileChangeHandler=function(I,H){F.pdpTypeNote(true);if(F.apnMode()!="manual"){return true}var G=F.getSelectedManualProfile();F.setUIData(G);C();return true};F.autoProfileChangeHandler=function(I,H){if(F.apnMode()!="auto"){return true}var G=b[F.selectedAutoProfile()];F.setUIData(G);C();return true};F.setUIData=function(G){clearValidateMsg("#apn_setting_form");if(!G){return}F.selectedPdpType(G.pdpType||"IP");F.selectedPdpTypeTmp(G.pdpType||"IP");F.profileName(G.profileName);F.apn(G.wanApn);F.dnsMode(G.dnsMode!="manual"?"auto":"manual");F.dns1(G.dns1);F.dns2(G.dns2);F.username(G.username);F.password(G.password);F.selectedAuthentication(G.authMode||"none");F.apnV6(G.wanApnV6);F.dnsModeV6(G.dnsModeV6!="manual"?"auto":"manual");F.dns1V6(G.dns1V6);F.dns2V6(G.dns2V6);F.usernameV6(G.usernameV6);F.passwordV6(G.passwordV6);F.selectedAuthenticationV6(G.authModeV6||"none")};function C(){var G=E();if(F.apnMode()=="auto"){if(F.selectedAutoProfile()==F.defApn()){F.defaultCfg(true)}else{F.defaultCfg(false)}}else{if(F.selectedProfile()==F.defApn()){F.defaultCfg(true)}else{F.defaultCfg(false)}}if(G<r.defaultApnSize){F.predeterminedCfg(true)}else{F.predeterminedCfg(false)}}F.apnModeChangeHandler=function(H,G){if(F.apnMode()=="auto"){if(F.showAutoApnDetail()){F.autoProfileChangeHandler()}}else{F.profileChangeHandler()}return true};F.setDefaultAct=function(){if(!F.selectedProfile()){showAlert("apn_no_select_alert");return false}var H=u.getConnectionInfo().connectStatus;if(H=="ppp_connected"){showAlert({msg:"apn_cant_modify_status",params:[f.i18n.prop("connected").toLowerCase()]});return false}else{if(H=="ppp_disconnecting"){showAlert({msg:"apn_cant_modify_status",params:[f.i18n.prop("disconnecting").toLowerCase()]});return false}else{if(H=="ppp_connecting"){showAlert({msg:"apn_cant_modify_status",params:[f.i18n.prop("connecting").toLowerCase()]});return false}}}if(F.apnMode()=="auto"||F.predeterminedCfg()){showLoading("waiting");v()}else{if(f("#apn_setting_form").valid()){var G=false;f.each(F.profiles(),function(I,J){if(J.value==F.profileName()){G=true}});if(G&&F.selectedProfile()!=F.profileName()){showInfo("apn_save_profile_exist");return false}y(true)}else{f(".error:first","#apn_setting_form").focus()}}};F.query_apn=function(){var G={at_str_data:"AT+CGDCONT?"};u.SendAT(G,function(H){console.log("sendAT enter"+H.result);recev_str=H.result.replace(/_/g,"\n");recev_str=recev_str.replace(/\s+/g,"");recev_str=recev_str.replace("OK","");var I=document.getElementById("CurrentApn");I.innerHTML=recev_str.replace(/~/g,'"')})};F.setCidReserved=function(){var G={};G.cid_reserved=f("#cid_reserved").val();showConfirm(f.i18n.prop("cid_set_confirm"),{ok:function(){u.setReservedCid(G)},no:function(){}})};function v(){var H=0;if(F.apnMode()=="auto"){H=D();F.selectedAutoProfile(f("#autoProfile").val())}else{H=E();F.selectedProfile(f("#profile").val())}var G=F.getSelectedManualProfile();u.setDefaultApn({index:H,apnMode:F.apnMode(),pdpType:G.pdpType,profileName:G.profileName,wanApn:G.wanApn,authMode:G.authMode,username:G.username,password:G.password,dnsMode:r.SHOW_APN_DNS?G.dnsMode:"auto",dns1:r.SHOW_APN_DNS?G.dns1:"",dns2:r.SHOW_APN_DNS?G.dns2:""},function(I){if(I.result){addTimeout(function(){n(true);F.apnModeChangeHandler();successOverlay()},500)}else{errorOverlay()}},function(I){errorOverlay()})}F.getSelectedManualProfile=function(){var H={};var G=f("#profile").val();if(typeof F.selectedProfile()=="undefined"){F.selectedProfile(G)}var J=j[G];var I=d[G];if(J&&I){if(!!J.pdpType){f.extend(H,I);f.extend(H,J)}else{f.extend(H,J);f.extend(H,I)}}else{if(J&&!I){f.extend(H,J)}}return H};function E(){var H=f("#profile option");if(H.length==0){H=F.profiles()}var G=0;for(;G<H.length;G++){if(H[G].value==F.selectedProfile()){break}}return G}function D(){var H=f("#autoProfile option");for(var G=0;G<H.length;G++){if(H[G].value==F.selectedAutoProfile()){return G}}return H.length-1}F.saveAct=function(){if(!f("#apn_setting_form").valid()){return false}if(!F.selectedProfile()&&!F.disableProfile()){showAlert("apn_no_select_alert");return false}var G=false;f.each(F.profiles(),function(I,J){if(J.value==F.profileName()){G=true}});if(F.disableProfile()==true){if(f("#profile option").length>=r.maxApnNumber){showInfo({msg:"apn_profile_full",params:[r.maxApnNumber]});return false}if(G){showInfo("apn_save_profile_exist");return false}var H=u.getStatusInfo();if(H.connectStatus=="ppp_connected"){showConfirm("apn_diconneted_network_confirm",function(){showLoading("disconnecting");u.disconnect({},function(I){if(I.result){r.connect_flag=true;A()}else{errorOverlay()}})})}else{A()}}else{if(G&&F.selectedProfile()!=F.profileName()){showInfo("apn_save_profile_exist");return false}if(F.predeterminedCfg()){errorOverlay();return false}if(F.predeterminedCfg()||F.defaultCfg()){y(false)}else{y(false)}}};function A(){showLoading("waiting");var H=f("option","#profile").length;if(H<r.defaultApnSize){errorOverlay();return}var G=false;if(r.IPV4V6_SUPPORT&&F.selectedPdpType()=="IPv4v6"){G=true}u.addOrEditApn({profileName:F.profileName(),pdpType:F.selectedPdpType(),index:H,wanApn:F.apn(),authMode:F.selectedAuthentication(),username:F.username(),password:F.password(),dnsMode:r.SHOW_APN_DNS?F.dnsMode():"auto",dns1:r.SHOW_APN_DNS?F.dns1():"",dns2:r.SHOW_APN_DNS?F.dns2():"",wanApnV6:G?F.apn():F.apnV6(),authModeV6:G?F.selectedAuthentication():F.selectedAuthenticationV6(),usernameV6:G?F.username():F.usernameV6(),passwordV6:G?F.password():F.passwordV6(),dnsModeV6:r.SHOW_APN_DNS?(G?F.dnsMode():F.dnsModeV6()):"auto",dns1V6:r.SHOW_APN_DNS?(G?F.dns1():F.dns1V6()):"",dns2V6:r.SHOW_APN_DNS?(G?F.dns2():F.dns2V6()):""},function(J){if(J.result){w=s();if(F.profileName()!=F.selectedProfile()){var I=F.profileName();F.profiles(p(w.apnConfigs));f("#profile").val(I).trigger("change")}v()}else{errorOverlay()}},function(I){errorOverlay()})}function y(H){showLoading();var I=E();var J=false;if(r.IPV4V6_SUPPORT&&F.selectedPdpType()=="IPv4v6"){J=true}var G=false;if(H||(F.predeterminedCfg()||F.defaultCfg())){G=true}u.addOrEditApn({profileName:F.profileName(),pdpType:F.selectedPdpType(),index:I,wanApn:F.apn(),authMode:F.selectedAuthentication(),username:F.username(),password:F.password(),dnsMode:r.SHOW_APN_DNS?F.dnsMode():"auto",dns1:r.SHOW_APN_DNS?F.dns1():"",dns2:r.SHOW_APN_DNS?F.dns2():"",wanApnV6:J?F.apn():F.apnV6(),authModeV6:J?F.selectedAuthentication():F.selectedAuthenticationV6(),usernameV6:J?F.username():F.usernameV6(),passwordV6:J?F.password():F.passwordV6(),dnsModeV6:r.SHOW_APN_DNS?(J?F.dnsMode():F.dnsModeV6()):"auto",dns1V6:r.SHOW_APN_DNS?(J?F.dns1():F.dns1V6()):"",dns2V6:r.SHOW_APN_DNS?(J?F.dns2():F.dns2V6()):""},function(L){if(L.result){w=s();if(F.profileName()!=F.selectedProfile()){var K=F.profileName();F.profiles(p(w.apnConfigs));f("#profile").val(K).trigger("change")}if(G){v()}else{successOverlay()}}else{errorOverlay()}},function(K){errorOverlay()})}var B={};F.addAct=function(){clearValidateMsg("#apn_setting_form");F.pdpTypeNote(true);F.disableProfile(true);F.addApnHide(true);B={profileName:F.profileName(),selectedPdpType:F.selectedPdpType(),wanApn:F.apn(),dnsMode:r.SHOW_APN_DNS?F.dnsMode():"auto",dns1:r.SHOW_APN_DNS?F.dns1():"",dns2:r.SHOW_APN_DNS?F.dns2():"",authMode:F.selectedAuthentication(),username:F.username(),password:F.password(),wanApnV6:F.apnV6(),dnsModeV6:r.SHOW_APN_DNS?F.dnsModeV6():"auto",dns1V6:r.SHOW_APN_DNS?F.dns1V6():"",dns2V6:r.SHOW_APN_DNS?F.dns2V6():"",authModeV6:F.selectedAuthenticationV6(),usernameV6:F.usernameV6(),passwordV6:F.passwordV6()};F.profileName("");F.selectedPdpType("IP");F.selectedPdpTypeTmp("IP");F.apn("");F.dnsMode("auto");F.dns1("");F.dns2("");F.selectedAuthentication("none");F.username("");F.password("");F.apnV6("");F.dnsModeV6("auto");F.dns1V6("");F.dns2V6("");F.selectedAuthenticationV6("none");F.usernameV6("");F.passwordV6("")};F.cancelAddAct=function(){clearValidateMsg("#apn_setting_form");F.pdpTypeNote(false);F.disableProfile(false);F.addApnHide(false);F.profileName(B.profileName);F.selectedPdpType(B.selectedPdpType);F.selectedPdpTypeTmp(B.selectedPdpType);F.apn(B.wanApn);F.dnsMode(B.dnsMode);F.dns1(B.dns1);F.dns2(B.dns2);F.selectedAuthentication(B.authMode);F.username(B.username);F.password(B.password);F.apnV6(B.wanApnV6);F.dnsModeV6(B.dnsModeV6);F.dns1V6(B.dns1V6);F.dns2V6(B.dns2V6);F.selectedAuthenticationV6(B.authModeV6);F.usernameV6(B.usernameV6);F.passwordV6(B.passwordV6)};F.deleteAct=function(){if(!F.selectedProfile()){showAlert("apn_no_select_alert");return false}if(F.predeterminedCfg()){errorOverlay("apn_delete_cant_delete_default");return false}if(s().profileName==F.profileName()){errorOverlay("apn_cant_delete_current");return false}showConfirm("apn_delete_confirm",function(){showLoading("deleting");u.deleteApn({index:E()},function(G){if(G.result){F.profiles(p(s().apnConfigs));F.selectedProfile(F.defApn());F.profileChangeHandler();successOverlay()}else{errorOverlay()}},function(G){errorOverlay()})})}}function a(){var v=u.getConnectionInfo();return v.connectStatus=="ppp_connected"}function i(){j={};d={};b={}}function n(x){i();var v=f("#container");c.cleanNode(v[0]);var w=new m();c.applyBindings(w,v[0]);if(!x){addInterval(function(){w.setDefaultVisible(!a())},1000)}f("#apn_setting_form").validate({submitHandler:function(){w.saveAct()},rules:{profile_name:"apn_profile_name_check",apn_ipv4_apn:"apn_check",apn_dns1_ipv4:"ipv4",apn_dns2_ipv4:"ipv4",apn_ipv6_apn:"apn_check",apn_dns1_ipv6:"ipv6",apn_dns2_ipv6:"ipv6",apn_user_name_ipv4:"ppp_username_check",apn_password_ipv4:"ppp_password_check",apn_user_name_ipv6:"ppp_username_check",apn_password_ipv6:"ppp_password_check"}})}return{init:n}});