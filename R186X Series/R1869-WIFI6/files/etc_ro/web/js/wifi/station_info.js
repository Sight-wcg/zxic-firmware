define(["underscore","jquery","knockout","config/config","service","config/menu"],function(f,d,h,c,e,b){function a(){var j=this;var m={ACL_mode:2,user_ip:"",macList:"",hostnameList:""};j.showCableDiv=true;j.supportBlock=c.STATION_BLOCK_SUPPORT;var l=b.findMenu("#parental_control");j.showPCLink=l&&l.length>0&&c.HAS_PARENTAL_CONTROL;j.deviceInfo=h.observableArray([]);j.cableDeviceInfo=h.observableArray([]);j.blackDevices=h.observableArray([]);j.blackDevicesMac=h.computed(function(){return f.map(j.blackDevices(),function(o){return o.macAddress})});j.showBlackDiv=h.observable(c.HAS_BLACK_AND_WHITE_FILTER?(m.ACL_mode=="2"?true:false):c.STATION_BLOCK_SUPPORT);h.computed(function(){j.deviceInfo();j.cableDeviceInfo();j.blackDevices();d("#station_info_div").translate()}).extend({notify:"always",throttle:300});var n=e.getHostNameList({}).devices;j.fetchAttachedDevices=function(o){e.getCurrentlyAttachedDevicesInfo({},function(p){if(k){return false}j.deviceInfo(f.map(p.attachedDevices,function(r,q){r.idx=f.uniqueId("wireless_");r.hostName=i.getHostName(r.hostName,r.macAddress,n);r.inBlackGroup=c.HAS_BLACK_AND_WHITE_FILTER&&m.ACL_mode!="2"?false:f.contains(j.blackDevicesMac(),r.macAddress);r.type=1;r.disableFlag=(c.HAS_BLACK_AND_WHITE_FILTER&&m.ACL_mode!="2")||r.inBlackGroup||k;return r}));if(f.isFunction(o)){o.apply(this)}})};j.fetchAttachedCableDevices=function(o){e.getAttachedCableDevices({},function(p){if(k){return false}j.cableDeviceInfo(f.map(p.attachedDevices,function(r,q){r.idx=f.uniqueId("cable_");r.hostName=i.getHostName(r.hostName,r.macAddress,n);r.type=2;return r}));if(f.isFunction(o)){o.apply(this)}})};j.fetchBlacklist=function(o){e.getMacFilterInfo({},function(p){m.ACL_mode=p.ACL_mode;m.macList=p.wifi_mac_black_list;m.hostnameList=p.wifi_hostname_black_list;m.user_ip=p.user_ip_addr;j.showBlackDiv(c.HAS_BLACK_AND_WHITE_FILTER?(m.ACL_mode=="2"?true:false):c.STATION_BLOCK_SUPPORT);var q=i.parseBlackString(p.wifi_mac_black_list,p.wifi_hostname_black_list);j.blackDevices(f.map(q,function(s,r){s.idx=f.uniqueId("black_");s.hostName=i.getHostName(s.hostName,s.macAddress,n);s.type=3;return s}));if(f.isFunction(o)){o.apply(this)}},d.noop)};j.fetchBlacklist();j.fetchAttachedDevices();if(j.showCableDiv){j.fetchAttachedCableDevices()}var k=0;addInterval(function(){if(k==0){j.fetchAttachedDevices()}},3000);if(j.showCableDiv){addInterval(function(){if(k==0){j.fetchAttachedCableDevices()}},5000)}j.wirelessBlockHandler=function(r){if(c.HAS_BLACK_AND_WHITE_FILTER&&m.ACL_mode!="2"){return false}if(r.ipAddress==m.user_ip){showAlert("black_yourself_tip");return false}if(m.macList.split(";").length==10){showAlert("black_list_max");return false}if(m.macList.indexOf(r.macAddress)!=-1){return false}if(k){j.cancelAllEditHostNameHandler()}showLoading("waiting");var p=m.hostnameList==""?r.hostName:r.hostName+";"+m.hostnameList;var o=m.macList==""?r.macAddress:r.macAddress+";"+m.macList;var q={ACL_mode:"2",wifi_hostname_black_list:p,wifi_mac_black_list:o};j.updateMacFilterList(q)};j.editHostNameHandler=function(o){k++;d("#hostname_input_"+o.idx).val(o.hostName);i.dealElement(true,o.idx);return false};j.saveHostNameHandler=function(q){var r=d("#hostname_input_"+q.idx);var p=r.val();if(p==""){d(".promptErrorLabel","#confirm-message-container").text(d.i18n.prop("required"));var o=r.closest("td").addClass("has-error");addTimeout(function(){o.removeClass("has-error")},5000);showAlert("required");return false}else{if(p.indexOf(" ")==0||p.lastIndexOf(" ")==(p.length-1)||/[\*\$\[&:,;<>'"\\`\]ï¿¥]{1,32}/.test(p)){showAlert("device_rename");return false}}showLoading("waiting");q.hostName=p;e.editHostName({hostname:q.hostName,mac:q.macAddress},function(){k=0;e.getHostNameList({},function(s){n=s.devices;if(q.type==1){j.fetchAttachedDevices(function(){hideLoading();successOverlay()})}else{if(q.type==2){j.fetchAttachedCableDevices(function(){hideLoading();successOverlay()})}else{if(q.type==3){j.fetchBlacklist(function(){hideLoading();successOverlay()})}}}})},function(){errorOverlay()})};j.cancelEditHostNameHandler=function(o){i.dealElement(false,o.idx);k--};j.cancelAllEditHostNameHandler=function(){i.dealElement(false,"all");k=0};j.blacklistRemoveHandler=function(r){if(m.macList.indexOf(r.macAddress)==-1){return false}if(k){j.cancelAllEditHostNameHandler()}showLoading("waiting");var q=[];var o=[];d.each(j.blackDevices(),function(s,t){if(t.macAddress!=r.macAddress){q.push(t.macAddress);o.push(t.hostName)}});var p={ACL_mode:"2",macFilteringMode:"2",wifi_hostname_black_list:o.join(";"),wifi_mac_black_list:q.join(";")};j.updateMacFilterList(p)};j.updateMacFilterList=function(o){e.setMacFilter(o,function(p){if(p.result=="success"){j.blackDevices([]);j.fetchBlacklist(function(){j.fetchAttachedDevices(function(){successOverlay()})})}},function(){errorOverlay()})}}var i={dealElement:function(k,j){if(j=="all"){d("input[id^='hostname_txt_'],a[id^='edit_btn_']").show();d("input[id^='hostname_input_'],a[id^='cancel_btn_'],a[id^='save_btn_']").hide()}else{if(k){d("#edit_btn_"+j+",#hostname_txt_"+j).hide();d("#save_btn_"+j+",#cancel_btn_"+j+",#hostname_input_"+j).show()}else{d("#edit_btn_"+j+",#hostname_txt_"+j).show();d("#save_btn_"+j+",#cancel_btn_"+j+",#hostname_input_"+j).hide()}}},parseBlackString:function(o,n){if(o==""){return[]}var l=n.split(";");var k=o.split(";");var j=[];for(var m=0;m<k.length;m++){var p={};p.hostName=l[m];p.macAddress=k[m];j.push({hostName:l[m],macAddress:k[m]})}return j},getHostName:function(m,l,k){var j=f.find(k,function(n){return n.mac==l});return j?j.hostname:m}};function g(){var j=d("#container")[0];h.cleanNode(j);var k=new a();h.applyBindings(k,j)}return{init:g}});