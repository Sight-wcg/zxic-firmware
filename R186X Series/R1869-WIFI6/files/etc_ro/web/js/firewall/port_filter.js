define(["jquery","knockout","config/config","service","underscore"],function(f,k,c,g,i){var a={ICMP:"ICMP",NONE:"None"};var h=i.map(c.FILTER_PROTOCOL_MODES,function(l){return new Option(l.name,l.value)});var e=[{columnType:"checkbox",rowText:"index",width:"4%"},{headerTextTrans:"mac_address",rowText:"macAddress",width:"12%"},{headerTextTrans:"ip_type",rowText:"ipType",width:"5%",display:c.IPV6_SUPPORT},{headerTextTrans:"source_ip_address",rowText:"sourceIpAddress",width:"12%"},{headerTextTrans:"dest_ip_address",rowText:"destIpAddress",width:"12%"},{headerTextTrans:"protocol",rowText:"protocol",width:"12%",needTrans:true},{headerTextTrans:"source_port_range",rowText:"sourcePortRange",width:"12%"},{headerTextTrans:"dest_port_range",rowText:"destPortRange",width:"12%"},{headerTextTrans:"port_filter_action",rowText:"action",width:"12%",needTrans:true},{headerTextTrans:"comment",rowText:"comment",width:"12%"}];function d(){var l=this;var m=b();l.portFilterEnable=k.observable(m.portFilterEnable);l.oriPortFilterEnable=k.observable(m.portFilterEnable);l.defaultPolicy=k.observable(m.defaultPolicy);l.oriDefaultPolicy=k.observable(m.defaultPolicy);l.portFilterAction=k.observable("");l.macAddress=k.observable("");l.destIpAddress=k.observable("");l.sourceIpAddress=k.observable("");l.sourceIpv6Address=k.observable("");l.destIpv6Address=k.observable("");l.destPortStart=k.observable("");l.destPortEnd=k.observable("");l.sourcePortStart=k.observable("");l.sourcePortEnd=k.observable("");l.modes=k.observableArray(h);l.selectedMode=k.observable("5");l.comment=k.observable("");l.ipv6Support=k.observable(c.IPV6_SUPPORT);l.ipType=k.observable("ipv4");l.rules=k.observableArray(m.portFilterRules);l.policyChangeHandler=function(){var n=l.defaultPolicy()=="1"?"Accept":"Drop";l.portFilterAction(n);return true};l.gridTemplate=new k.simpleGrid.viewModel({data:l.rules(),idName:"index",columns:e,tmplType:"list",pageSize:20});l.callback=function(n){if(n.result=="success"){l.clear();j(l);successOverlay()}else{errorOverlay()}};l.clear=function(){l.macAddress("");l.destIpAddress("");l.destIpv6Address("");l.sourceIpAddress("");l.sourceIpv6Address("");l.destPortStart("0");l.destPortEnd("0");l.sourcePortStart("0");l.sourcePortEnd("0");l.selectedMode("None");l.comment("");clearValidateMsg()};l.setPortFilterBasic=function(){showLoading();var n={};n.portFilterEnable=l.portFilterEnable();n.defaultPolicy=l.defaultPolicy();g.setPortFilterBasic(n,l.callback)};l.save=function(){l.macAddress(l.macAddress().replace(/\s+/g,""));l.destIpv6Address(l.destIpv6Address().replace(/\s+/g,""));l.sourceIpv6Address(l.sourceIpv6Address().replace(/\s+/g,""));l.destIpAddress(l.destIpAddress().replace(/\s+/g,""));l.sourceIpAddress(l.sourceIpAddress().replace(/\s+/g,""));if(l.ipv6Support()){var o=l.ipType()=="ipv4"?"IPv4":"IPv6";var n=i.filter(l.rules(),function(p){return p.ipType==o});if(n.length>=c.portForwardMax){showAlert({msg:"rules_max_v4v6",params:[o,c.portForwardMax]});return}if(l.checkExist()){showAlert({msg:"rule_exist_v4v6",params:o});return}}else{if(l.rules().length>=c.portForwardMax){showAlert({msg:"rules_max",params:c.portForwardMax});return}if(l.checkExist()){showAlert("rule_exist");return}}showConfirm("confirm_data_effect",function(){showLoading();var p={};p.macAddress=l.macAddress();if(l.ipv6Support()&&l.ipType()=="ipv6"){p.destIpAddress=l.destIpv6Address();p.sourceIpAddress=l.sourceIpv6Address()}else{p.destIpAddress=l.destIpAddress();p.sourceIpAddress=l.sourceIpAddress()}p.destPortStart=l.destPortStart();p.destPortEnd=l.destPortEnd();p.sourcePortStart=l.sourcePortStart();p.sourcePortEnd=l.sourcePortEnd();p.action=l.portFilterAction();p.protocol=l.selectedMode();p.comment=l.comment();p.ipType=l.ipType();g.setPortFilter(p,l.callback)})};l.checkExist=function(){l.macAddress(l.macAddress().toUpperCase());var n=l.ipType().toUpperCase();var p={macAddress:l.macAddress(),destIpAddress:n=="IPV4"?l.destIpAddress():l.destIpv6Address(),sourceIpAddress:n=="IPV4"?l.sourceIpAddress():l.sourceIpv6Address(),destPortRange:l.destPortStart()=="0"?"":l.destPortStart()+" - "+l.destPortEnd(),sourcePortRange:l.sourcePortStart()=="0"?"":l.sourcePortStart()+" - "+l.sourcePortEnd(),action:l.portFilterAction()=="Drop"?"filter_drop":"filter_accept",protocol:transProtocolValue(l.selectedMode()),ipType:n};var r;var q=l.rules();for(var o=0;o<q.length;o++){r={macAddress:q[o].macAddress,destIpAddress:q[o].destIpAddress,sourceIpAddress:q[o].sourceIpAddress,destPortRange:q[o].destPortRange,sourcePortRange:q[o].sourcePortRange,action:q[o].action,protocol:q[o].protocol,ipType:q[o].ipType.toUpperCase()};if(i.isEqual(p,r)){return true}}return false};l.deleteFilterRules=function(){var n=l.gridTemplate.selectedIds();if(n.length==0){showAlert("no_data_selected");return}showConfirm("confirm_data_effect",function(){showLoading("deleting");var o={};o.indexs=n;g.deleteFilterRules(o,l.callback)})};l.protocolChangeHandler=function(){if(l.selectedMode()==a.ICMP||l.selectedMode()==a.NONE){l.destPortStart("0");l.destPortEnd("0");l.sourcePortStart("0");l.sourcePortEnd("0");clearValidateMsg("#portRangeArea")}else{l.destPortStart("1");l.destPortEnd("65535");l.sourcePortStart("1");l.sourcePortEnd("65535")}return true};l.ipTypeChangeHandler=function(){clearValidateMsg();return true};l.policyChangeHandler()}function b(){return g.getPortFilter()}function j(m){var n;if(m){n=m;var o=b();n.portFilterEnable(o.portFilterEnable);n.oriPortFilterEnable(o.portFilterEnable);n.defaultPolicy(o.defaultPolicy);n.oriDefaultPolicy(o.defaultPolicy);n.rules(o.portFilterRules);n.gridTemplate.clearAllChecked();n.gridTemplate.data(o.portFilterRules);refreshTableHeight();f("#portFilters").find("tbody").translate();renderCheckbox();f(".notes-content").translate();return}n=new d();var l=f("#container");k.cleanNode(l[0]);k.applyBindings(n,l[0]);fixTableHeight();f("#filterBasicForm").validate({submitHandler:function(){showConfirm("confirm_data_effect",function(){n.setPortFilterBasic()})}});f("#portFilterListForm").validate({submitHandler:function(){n.deleteFilterRules()}});f("#portFilterForm").validate({submitHandler:function(){n.save()},rules:{txtMacAddress:{filter_optional:true,mac_check:true},txtDestIpAddress:{ip_check:true},txtSourceIpAddress:{ip_check:true},txtSourceIpv6Address:{ipv6:true},txtDestIpv6Address:{ipv6:true},txtDestPortStart:{digits:true,range:[1,65535],portCompare:"#txtDestPortEnd"},txtDestPortEnd:{digits:true,range:[1,65535],portCompare:"#txtDestPortStart"},txtSourcePortStart:{digits:true,range:[1,65535],portCompare:"#txtSourcePortEnd"},txtSourcePortEnd:{digits:true,range:[1,65535],portCompare:"#txtSourcePortStart"},txtComment:{comment_check:true}},groups:{destPort:"txtDestPortStart txtDestPortEnd",sourcePort:"txtSourcePortStart txtSourcePortEnd"},errorPlacement:function(p,q){if(q.attr("name")=="txtMacAddress"){p.appendTo("#macErrorDiv")}else{if(q.attr("name")=="txtDestPortStart"||q.attr("name")=="txtDestPortEnd"){p.appendTo("#destPortErrorDiv")}else{if(q.attr("name")=="txtSourcePortStart"||q.attr("name")=="txtSourcePortEnd"){p.appendTo("#sourcePortErrorDiv")}else{p.insertAfter(q)}}}}})}f.validator.addMethod("filter_optional",function(o,n,p){var l=i.any(["#txtMacAddress","#txtDestIpAddress","#txtSourceIpAddress","#txtSourceIpv6Address","#txtDestIpv6Address"],function(r){var q=f(r).val().replace(/\s+/g,"");return f(r+":visible").length>0&&q!=""});var m=i.any(["#txtDestPortStart","#txtDestPortEnd","#txtSourcePortStart","#txtSourcePortEnd"],function(q){return f(q).val()!="0"});return l||m});return{init:j}});